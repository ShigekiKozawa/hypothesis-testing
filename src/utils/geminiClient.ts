import { GoogleGenerativeAI } from '@google/generative-ai';

const API_KEY = (import.meta as any).env?.VITE_GEMINI_API_KEY;

if (!API_KEY) {
  throw new Error(
    'VITE_GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n' +
    '.env.local ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã€APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚'
  );
}

const genAI = new GoogleGenerativeAI(API_KEY);

const API_TIMEOUT = 60000;
const MAX_RETRIES = 3;
const MIN_QUESTION_COUNT = 1;
const MAX_QUESTION_COUNT = 50;

export interface GeneratedQuestion {
  id: number;
  question: string;
  options: string[];
  correct: number;
  explanation: string;
  chartType?: 'scatter' | 'line' | 'bar' | 'histogram' | 'boxplot';
  chartData?: Array<{x: number; y: number} | {name: string; value: number}>;
  barData?: Array<{name: string; value: number}>;
  boxPlotData?: { min: number; q1: number; median: number; q3: number; max: number };
  chartLabels?: {x: string; y: string};
}

export interface QuestionGenerationRequest {
  grade: '3ç´š' | '4ç´š';
  type: 'section' | 'exam';
  section?: string;
  sectionDescription?: string;
  count: number;
}

export class ValidationError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'ValidationError';
  }
}

export class APIError extends Error {
  constructor(message: string, public statusCode?: number, public retryAfter?: number) {
    super(message);
    this.name = 'APIError';
  }
}

export class RateLimitError extends Error {
  constructor(message: string, public retryAfter: number) {
    super(message);
    this.name = 'RateLimitError';
  }
}

export class TimeoutError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'TimeoutError';
  }
}

function validateRequest(request: QuestionGenerationRequest): void {
  if (!request.grade || (request.grade !== '3ç´š' && request.grade !== '4ç´š')) {
    throw new ValidationError(`ç„¡åŠ¹ãªç´šã§ã™: ${request.grade}ã€‚'3ç´š'ã¾ãŸã¯'4ç´š'ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚`);
  }

  if (!request.type || (request.type !== 'section' && request.type !== 'exam')) {
    throw new ValidationError(`ç„¡åŠ¹ãªã‚¿ã‚¤ãƒ—ã§ã™: ${request.type}ã€‚'section'ã¾ãŸã¯'exam'ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚`);
  }

  if (typeof request.count !== 'number' || !Number.isInteger(request.count)) {
    throw new ValidationError(`å•é¡Œæ•°ã¯æ•´æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™: ${request.count}`);
  }

  if (request.count < MIN_QUESTION_COUNT || request.count > MAX_QUESTION_COUNT) {
    throw new ValidationError(
      `å•é¡Œæ•°ã¯${MIN_QUESTION_COUNT}ã€œ${MAX_QUESTION_COUNT}ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚æŒ‡å®šã•ã‚ŒãŸå€¤: ${request.count}`
    );
  }

  if (request.type === 'section' && !request.section) {
    throw new ValidationError('ã‚¿ã‚¤ãƒ—ãŒ"section"ã®å ´åˆã€sectionãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¿…é ˆã§ã™ã€‚');
  }
}

function validateQuestion(question: any, index: number): GeneratedQuestion {
  if (!question || typeof question !== 'object') {
    throw new ValidationError(`å•é¡Œ${index + 1}ãŒç„¡åŠ¹ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚`);
  }

  if (typeof question.id !== 'number' || !Number.isInteger(question.id) || question.id < 1) {
    throw new ValidationError(`å•é¡Œ${index + 1}ã®IDãŒç„¡åŠ¹ã§ã™: ${question.id}`);
  }

  if (typeof question.question !== 'string' || question.question.trim().length === 0) {
    throw new ValidationError(`å•é¡Œ${index + 1}ã®å•é¡Œæ–‡ãŒç„¡åŠ¹ã§ã™ã€‚`);
  }

  if (!Array.isArray(question.options) || question.options.length !== 4) {
    throw new ValidationError(`å•é¡Œ${index + 1}ã®é¸æŠè‚¢ã¯4ã¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`);
  }

  for (let i = 0; i < question.options.length; i++) {
    if (typeof question.options[i] !== 'string' || question.options[i].trim().length === 0) {
      throw new ValidationError(`å•é¡Œ${index + 1}ã®é¸æŠè‚¢${i + 1}ãŒç„¡åŠ¹ã§ã™ã€‚`);
    }
  }

  if (typeof question.correct !== 'number' || !Number.isInteger(question.correct)) {
    throw new ValidationError(`å•é¡Œ${index + 1}ã®æ­£è§£ç•ªå·ãŒç„¡åŠ¹ã§ã™: ${question.correct}`);
  }

  if (question.correct < 1 || question.correct > 4) {
    throw new ValidationError(`å•é¡Œ${index + 1}ã®æ­£è§£ç•ªå·ã¯1ã€œ4ã®ç¯„å›²ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™: ${question.correct}`);
  }

  if (typeof question.explanation !== 'string' || question.explanation.trim().length === 0) {
    throw new ValidationError(`å•é¡Œ${index + 1}ã®è§£èª¬ãŒç„¡åŠ¹ã§ã™ã€‚`);
  }

  return {
    id: question.id,
    question: question.question.trim(),
    options: question.options.map((opt: string) => opt.trim()),
    correct: question.correct,
    explanation: question.explanation.trim(),
  };
}

function sanitizeText(text: string): string {
  return text
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/<[^>]*>/g, '')
    .trim();
}

function detectGraphReference(question: string): boolean {
  const graphKeywords = [
    'ä¸‹ã®ã‚°ãƒ©ãƒ•', 'æ¬¡ã®ã‚°ãƒ©ãƒ•', 'ä»¥ä¸‹ã®ã‚°ãƒ©ãƒ•',
    'ä¸‹ã®å›³', 'æ¬¡ã®å›³', 'ä»¥ä¸‹ã®å›³',
    'ä¸‹ã®æ•£å¸ƒå›³', 'æ¬¡ã®æ•£å¸ƒå›³',
    'ä¸‹ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ', 'æ¬¡ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ',
    'ä¸‹ã®ç®±ã²ã’å›³', 'æ¬¡ã®ç®±ã²ã’å›³',
    'ä¸‹ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•', 'æ¬¡ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•',
    'ä¸‹ã®æ£’ã‚°ãƒ©ãƒ•', 'æ¬¡ã®æ£’ã‚°ãƒ©ãƒ•'
  ];
  return graphKeywords.some(keyword => question.includes(keyword));
}

function detectGraphType(question: string, options: string[]): 'histogram' | 'boxplot' | 'scatter' | 'line' | 'bar' | null {
  const text = question + ' ' + options.join(' ');
  
  if (text.includes('ç®±ã²ã’å›³') || text.includes('å››åˆ†ä½') || text.includes('IQR') || text.includes('Q1') || text.includes('Q3')) {
    return 'boxplot';
  }
  if (text.includes('ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ') || text.includes('åº¦æ•°åˆ†å¸ƒ') || text.includes('éšç´š') || text.includes('æœ€é »å€¤')) {
    return 'histogram';
  }
  if (text.includes('æ•£å¸ƒå›³') || text.includes('ç›¸é–¢') || text.includes('å›å¸°')) {
    return 'scatter';
  }
  if (text.includes('æŠ˜ã‚Œç·š') || text.includes('æ™‚ç³»åˆ—') || text.includes('æ¨ç§»') || text.includes('å‚¾å‘')) {
    return 'line';
  }
  if (text.includes('æ£’ã‚°ãƒ©ãƒ•') || text.includes('ã‚«ãƒ†ã‚´ãƒªãƒ¼') || text.includes('æ¯”è¼ƒ')) {
    return 'bar';
  }
  
  return 'histogram';
}

function generateHistogramData(): { barData: Array<{name: string; value: number}>; chartLabels: {x: string; y: string} } {
  const classCount = 6 + Math.floor(Math.random() * 4);
  const barData = [];
  
  for (let i = 0; i < classCount; i++) {
    const start = i * 10;
    const end = (i + 1) * 10;
    const value = Math.floor(Math.random() * 15) + 5;
    barData.push({
      name: `${start}-${end}`,
      value: value
    });
  }
  
  return {
    barData,
    chartLabels: { x: 'éšç´š', y: 'åº¦æ•°' }
  };
}

function generateBoxPlotData(): { boxPlotData: { min: number; q1: number; median: number; q3: number; max: number } } {
  const min = 40 + Math.floor(Math.random() * 10);
  const q1 = min + 10 + Math.floor(Math.random() * 10);
  const median = q1 + 8 + Math.floor(Math.random() * 8);
  const q3 = median + 8 + Math.floor(Math.random() * 10);
  const max = q3 + 10 + Math.floor(Math.random() * 15);
  
  return {
    boxPlotData: { min, q1, median, q3, max }
  };
}

function generateScatterData(): { chartData: Array<{x: number; y: number}>; chartLabels: {x: string; y: string} } {
  const pointCount = 6 + Math.floor(Math.random() * 5);
  const chartData = [];
  const slope = 1.5 + Math.random() * 1.5;
  const intercept = 1 + Math.random() * 3;
  
  for (let i = 0; i < pointCount; i++) {
    const x = i + 1;
    const y = slope * x + intercept + (Math.random() - 0.5) * 2;
    chartData.push({ x, y: Math.round(y * 10) / 10 });
  }
  
  return {
    chartData,
    chartLabels: { x: 'å¤‰æ•°X', y: 'å¤‰æ•°Y' }
  };
}

function generateLineData(): { chartData: Array<{name: string; value: number}>; chartLabels: {x: string; y: string} } {
  const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ'];
  const pointCount = 5 + Math.floor(Math.random() * 4);
  const chartData = [];
  
  let value = 100 + Math.floor(Math.random() * 50);
  for (let i = 0; i < pointCount; i++) {
    chartData.push({
      name: months[i],
      value: value
    });
    value += Math.floor(Math.random() * 20) - 5;
  }
  
  return {
    chartData,
    chartLabels: { x: 'æœˆ', y: 'å€¤' }
  };
}

function generateBarData(): { barData: Array<{name: string; value: number}>; chartLabels: {x: string; y: string} } {
  const categories = ['A', 'B', 'C', 'D', 'E'];
  const barData = categories.map(cat => ({
    name: cat,
    value: Math.floor(Math.random() * 80) + 20
  }));
  
  return {
    barData,
    chartLabels: { x: 'ã‚«ãƒ†ã‚´ãƒªãƒ¼', y: 'å€¤' }
  };
}

function ensureGraphData(question: GeneratedQuestion): void {
  const hasGraphReference = detectGraphReference(question.question);
  
  if (!hasGraphReference) {
    return;
  }
  
  const hasChartType = !!question.chartType;
  const hasChartData = !!(question.chartData || question.barData || question.boxPlotData);
  
  if (hasChartType && hasChartData) {
    console.log(`âœ… å•é¡Œ${question.id}: ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå«ã¾ã‚Œã¦ã„ã¾ã™ (${question.chartType})`);
    return;
  }
  
  console.warn(`âš ï¸ å•é¡Œ${question.id}: ã‚°ãƒ©ãƒ•å‚ç…§ãŒã‚ã‚‹ã®ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚`);
  
  let detectedType = question.chartType || detectGraphType(question.question, question.options);
  
  if (!detectedType) {
    detectedType = 'histogram';
  }
  
  question.chartType = detectedType;
  
  switch (detectedType) {
    case 'histogram': {
      const data = generateHistogramData();
      question.barData = data.barData;
      question.chartLabels = data.chartLabels;
      console.log(`âœ… å•é¡Œ${question.id}: ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸ`);
      break;
    }
    case 'boxplot': {
      const data = generateBoxPlotData();
      question.boxPlotData = data.boxPlotData;
      console.log(`âœ… å•é¡Œ${question.id}: ç®±ã²ã’å›³ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸ`);
      break;
    }
    case 'scatter': {
      const data = generateScatterData();
      question.chartData = data.chartData;
      question.chartLabels = data.chartLabels;
      console.log(`âœ… å•é¡Œ${question.id}: æ•£å¸ƒå›³ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸ`);
      break;
    }
    case 'line': {
      const data = generateLineData();
      question.chartData = data.chartData;
      question.chartLabels = data.chartLabels;
      console.log(`âœ… å•é¡Œ${question.id}: æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸ`);
      break;
    }
    case 'bar': {
      const data = generateBarData();
      question.barData = data.barData;
      question.chartLabels = data.chartLabels;
      console.log(`âœ… å•é¡Œ${question.id}: æ£’ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸ`);
      break;
    }
  }
}

async function withTimeout<T>(promise: Promise<T>, timeoutMs: number): Promise<T> {
  let timeoutHandle: number | undefined;
  
  const timeoutPromise = new Promise<never>((_, reject) => {
    timeoutHandle = window.setTimeout(() => {
      reject(new TimeoutError(`å‡¦ç†ãŒ${timeoutMs / 1000}ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚`));
    }, timeoutMs);
  });

  try {
    const result = await Promise.race([promise, timeoutPromise]);
    if (timeoutHandle !== undefined) {
      window.clearTimeout(timeoutHandle);
    }
    return result;
  } catch (error) {
    if (timeoutHandle !== undefined) {
      window.clearTimeout(timeoutHandle);
    }
    throw error;
  }
}

async function retryWithBackoff<T>(
  fn: () => Promise<T>,
  retries: number = MAX_RETRIES,
  delay: number = 1000
): Promise<T> {
  try {
    return await fn();
  } catch (error) {
    if (retries <= 0) {
      throw error;
    }

    if (error instanceof ValidationError) {
      throw error;
    }

    if (error instanceof RateLimitError) {
      const waitTime = error.retryAfter || delay;
      console.warn(`ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã€‚${waitTime}mså¾Œã«ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™... æ®‹ã‚Š${retries}å›`);
      await new Promise(resolve => setTimeout(resolve, waitTime));
      return retryWithBackoff(fn, retries - 1, Math.max(waitTime * 2, delay * 2));
    }

    console.warn(`ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™... æ®‹ã‚Š${retries}å› (${delay}mså¾…æ©Ÿ)`);
    await new Promise(resolve => setTimeout(resolve, delay));
    return retryWithBackoff(fn, retries - 1, delay * 2);
  }
}

const sectionPrompts: Record<string, { grade3?: string; grade4?: string }> = {
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ã¨åŸºæœ¬ã‚°ãƒ©ãƒ•': {
    grade3: `
ã€å‡ºé¡Œã®èƒŒæ™¯ã¨ç›®çš„ã€‘
ãƒ‡ãƒ¼ã‚¿åˆ†æã®ç¬¬ä¸€æ­©ã¨ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã®æ€§è³ªã‚’æ­£ã—ãç†è§£ã—ã€é©åˆ‡ãªå¯è¦–åŒ–æ‰‹æ³•ã‚’é¸æŠã§ãã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ã®å°ºåº¦æ°´æº–ã¨å¯è¦–åŒ–æ‰‹æ³•ã®é–¢ä¿‚ã‚’æ·±ãç†è§£ã—ã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

ã€è©³ç´°ãªå‡ºé¡Œå†…å®¹ã€‘
1. ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ã®è­˜åˆ¥
   - é‡çš„å¤‰æ•°ï¼ˆé€£ç¶šå¤‰æ•°ï¼šèº«é•·ã€ä½“é‡ã€æ™‚é–“ãªã© / é›¢æ•£å¤‰æ•°ï¼šäººæ•°ã€å›æ•°ãªã©ï¼‰ã¨è³ªçš„å¤‰æ•°ï¼ˆåç¾©å°ºåº¦ï¼šè¡€æ¶²å‹ã€æ€§åˆ¥ / é †åºå°ºåº¦ï¼šæº€è¶³åº¦ã€æˆç¸¾ï¼‰ã®é•ã„
   - å„ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã«å¯¾ã™ã‚‹é©åˆ‡ãªçµ±è¨ˆå‡¦ç†ã®åˆ¤æ–­
   - å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ä¾‹ã‹ã‚‰å¤‰æ•°ã®ç¨®é¡ã‚’æ­£ã—ãåˆ†é¡ã™ã‚‹èƒ½åŠ›

2. ã‚°ãƒ©ãƒ•ã®ç‰¹æ€§ã¨é¸æŠåŸºæº–
   - æ£’ã‚°ãƒ©ãƒ•ï¼šã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã®é‡ã‚’æ¯”è¼ƒã™ã‚‹éš›ã«ä½¿ç”¨ã€‚ç¸¦è»¸ã¯ã‚¼ãƒ­ã‹ã‚‰é–‹å§‹ã™ã‚‹åŸå‰‡
   - å††ã‚°ãƒ©ãƒ•ï¼šå…¨ä½“ã«å¯¾ã™ã‚‹å„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å‰²åˆã‚’ç¤ºã™ã€‚åˆè¨ˆãŒ100%ã¨ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã«é©ç”¨
   - æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼šæ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã‚„é€£ç¶šçš„ãªå¤‰åŒ–ã‚’è¡¨ç¾ã€‚ç‚¹ã¨ç‚¹ã‚’çµã¶ã“ã¨ã§å‚¾å‘ã‚’è¦–è¦šåŒ–
   - å„ã‚°ãƒ©ãƒ•ã®ä½¿ç”¨ãŒä¸é©åˆ‡ãªã‚±ãƒ¼ã‚¹ï¼ˆä¾‹ï¼šæ™‚ç³»åˆ—ã§ãªã„ãƒ‡ãƒ¼ã‚¿ã«æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã‚’ä½¿ç”¨ï¼‰

3. ã‚°ãƒ©ãƒ•ã®èª­è§£ã¨ä½œæˆ
   - è»¸ã®ãƒ©ãƒ™ãƒ«ã€å˜ä½ã€ç›®ç››ã‚Šã®é©åˆ‡ãªè¨­å®š
   - ã‚°ãƒ©ãƒ•ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹æƒ…å ±ã¨èª­ã¿å–ã‚Œãªã„æƒ…å ±ã®åŒºåˆ¥
   - èª¤è§£ã‚’æ‹›ãã‚°ãƒ©ãƒ•ã®ç‰¹å¾´ï¼ˆä¾‹ï¼šç¸¦è»¸ãŒã‚¼ãƒ­ã‹ã‚‰å§‹ã¾ã‚‰ãªã„ã€ä¸é©åˆ‡ãªç¸®å°ºï¼‰

ã€å•é¡Œã®å…·ä½“ä¾‹ã€‘
ä¾‹1ï¼šã€Œã‚ã‚‹ã‚¯ãƒ©ã‚¹ã®ç”Ÿå¾’30äººã«ã¤ã„ã¦ã€å¥½ããªã‚¹ãƒãƒ¼ãƒ„ï¼ˆã‚µãƒƒã‚«ãƒ¼ã€é‡çƒã€ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«ï¼‰ã‚’èª¿æŸ»ã—ãŸã€‚ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–ã™ã‚‹éš›ã€æœ€ã‚‚é©åˆ‡ãªã‚°ãƒ©ãƒ•ã¯ã©ã‚Œã‹ï¼Ÿã€
â†’ ã“ã®ã‚ˆã†ãªå®Ÿè·µçš„ãªã‚·ãƒŠãƒªã‚ªãƒ™ãƒ¼ã‚¹ã®å•é¡Œ

ä¾‹2ï¼šã€ŒæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ãŒé©ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ã©ã‚Œã‹ã€‚(1)å„éƒ½é“åºœçœŒã®äººå£ (2)æœˆã”ã¨ã®æ°—æ¸©ã®å¤‰åŒ– (3)è¡€æ¶²å‹ã®å‰²åˆ (4)ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®æº€è¶³åº¦ã€
â†’ ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã¨ã‚°ãƒ©ãƒ•ã®å¯¾å¿œã‚’å•ã†å•é¡Œ`,

    grade4: `
ã€å‡ºé¡Œã®èƒŒæ™¯ã¨ç›®çš„ã€‘
ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãåˆ†é¡ã—ã€é©åˆ‡ãªæ–¹æ³•ã§å¯è¦–åŒ–ã™ã‚‹ã“ã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿åˆ†æã®åŸºç¤ã¨ãªã‚Šã¾ã™ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€èº«è¿‘ãªãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãæ‰±ãˆã‚‹ã‹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

ã€è©³ç´°ãªå‡ºé¡Œå†…å®¹ã€‘
1. é‡çš„ãƒ‡ãƒ¼ã‚¿ã¨è³ªçš„ãƒ‡ãƒ¼ã‚¿ã®é•ã„
   - é‡çš„ãƒ‡ãƒ¼ã‚¿ï¼šæ•°å€¤ã§æ¸¬å®šã§ãã€è¨ˆç®—ï¼ˆè¶³ã—ç®—ã€å¹³å‡ãªã©ï¼‰ãŒæ„å‘³ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿
     å…·ä½“ä¾‹ï¼šèº«é•·ã€ä½“é‡ã€ãƒ†ã‚¹ãƒˆã®ç‚¹æ•°ã€æ°—æ¸©ã€å£²ä¸Šé‡‘é¡
   - è³ªçš„ãƒ‡ãƒ¼ã‚¿ï¼šã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚„ç¨®é¡ã‚’è¡¨ã™ãƒ‡ãƒ¼ã‚¿ã€‚æ•°å€¤ã§è¡¨ã•ã‚Œã¦ã‚‚è¨ˆç®—ã¯æ„å‘³ã‚’æŒãŸãªã„
     å…·ä½“ä¾‹ï¼šæ€§åˆ¥ã€è¡€æ¶²å‹ã€è‰²ã€å¥½ããªé£Ÿã¹ç‰©ã€ä½ã‚“ã§ã„ã‚‹åœ°åŸŸ

2. ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ã«å¿œã˜ãŸã‚°ãƒ©ãƒ•ã®é¸æŠ
   - æ£’ã‚°ãƒ©ãƒ•ï¼šã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã®å€‹æ•°ã‚„é‡ã‚’æ¯”è¼ƒï¼ˆä¾‹ï¼šå„æœˆã®å£²ä¸Šã€ç§‘ç›®åˆ¥ã®ãƒ†ã‚¹ãƒˆçµæœï¼‰
   - å††ã‚°ãƒ©ãƒ•ï¼šå…¨ä½“ã«å¯¾ã™ã‚‹å„éƒ¨åˆ†ã®å‰²åˆï¼ˆä¾‹ï¼šäºˆç®—ã®å†…è¨³ã€æ™‚é–“ã®ä½¿ã„æ–¹ï¼‰
   - æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼šæ™‚é–“çš„ãªå¤‰åŒ–ã‚„æ¨ç§»ï¼ˆä¾‹ï¼šæ°—æ¸©ã®å¤‰åŒ–ã€äººå£ã®æ¨ç§»ï¼‰

3. ã‚°ãƒ©ãƒ•ã‹ã‚‰ã®æƒ…å ±èª­ã¿å–ã‚Š
   - ã‚°ãƒ©ãƒ•ã®ã‚¿ã‚¤ãƒˆãƒ«ã€è»¸ã®ãƒ©ãƒ™ãƒ«ã€å‡¡ä¾‹ã®ç¢ºèª
   - æœ€å¤§å€¤ãƒ»æœ€å°å€¤ã®èª­ã¿å–ã‚Š
   - å¤‰åŒ–ã®å‚¾å‘ï¼ˆå¢—åŠ ãƒ»æ¸›å°‘ï¼‰ã®æŠŠæ¡
   - ã‚°ãƒ©ãƒ•ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ã“ã¨ãƒ»èª­ã¿å–ã‚Œãªã„ã“ã¨ã®åŒºåˆ¥

ã€å•é¡Œã®å…·ä½“ä¾‹ã€‘
ä¾‹1ï¼šã€Œæ¬¡ã®ã†ã¡ã€é‡çš„ãƒ‡ãƒ¼ã‚¿ã¯ã©ã‚Œã‹ã€‚(1)å¥½ããªè‰² (2)ãƒ†ã‚¹ãƒˆã®ç‚¹æ•° (3)è¡€æ¶²å‹ (4)å‡ºèº«åœ°ã€
â†’ åŸºæœ¬çš„ãªè­˜åˆ¥å•é¡Œ

ä¾‹2ï¼šã€Œ1å¹´é–“ã®æœˆåˆ¥å£²ä¸Šã‚’è¡¨ã™ã®ã«æœ€ã‚‚é©ã—ãŸã‚°ãƒ©ãƒ•ã¯ã©ã‚Œã‹ã€‚(1)å††ã‚°ãƒ©ãƒ• (2)æ£’ã‚°ãƒ©ãƒ• (3)æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• (4)ã©ã‚Œã§ã‚‚ã‚ˆã„ã€
â†’ ãƒ‡ãƒ¼ã‚¿ã®æ€§è³ªã¨ã‚°ãƒ©ãƒ•ã®å¯¾å¿œã‚’å•ã†å•é¡Œ

ä¾‹3ï¼šã€Œå††ã‚°ãƒ©ãƒ•ã‚’ä½¿ã†ã®ãŒæœ€ã‚‚é©åˆ‡ãªã®ã¯ã©ã®ãƒ‡ãƒ¼ã‚¿ã‹ã€‚(1)å„æœˆã®æ°—æ¸© (2)ã‚¯ãƒ©ã‚¹ã®è¡€æ¶²å‹ã®å‰²åˆ (3)1é€±é–“ã®ä½“é‡ã®å¤‰åŒ– (4)ãƒ†ã‚¹ãƒˆã®ç‚¹æ•°åˆ†å¸ƒã€
â†’ ã‚°ãƒ©ãƒ•ã®ç‰¹æ€§ç†è§£ã‚’å•ã†å•é¡Œ`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ã¨ã‚°ãƒ©ãƒ•': {
    grade4: `é‡çš„ãƒ‡ãƒ¼ã‚¿ã¨è³ªçš„ãƒ‡ãƒ¼ã‚¿ã®è­˜åˆ¥ã€ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ã«å¿œã˜ãŸé©åˆ‡ãªã‚°ãƒ©ãƒ•ã®é¸æŠï¼ˆæ£’ã‚°ãƒ©ãƒ•ã€å††ã‚°ãƒ©ãƒ•ã€æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼‰ã€ã‚°ãƒ©ãƒ•ã‹ã‚‰ã®æƒ…å ±èª­ã¿å–ã‚Š`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: è¨˜è¿°çµ±è¨ˆé‡ã®åŸºç¤': {
    grade3: `
ã€å‡ºé¡Œã®èƒŒæ™¯ã¨ç›®çš„ã€‘
ãƒ‡ãƒ¼ã‚¿ã®ä¸­å¿ƒå‚¾å‘ã‚’è¡¨ã™ä»£è¡¨å€¤ã¯ã€ãƒ‡ãƒ¼ã‚¿ã®ç‰¹å¾´ã‚’ä¸€ã¤ã®æ•°å€¤ã§è¦ç´„ã™ã‚‹é‡è¦ãªæŒ‡æ¨™ã§ã™ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€å„ä»£è¡¨å€¤ã®è¨ˆç®—æ–¹æ³•ã ã‘ã§ãªãã€ã©ã®å ´é¢ã§ã©ã®ä»£è¡¨å€¤ã‚’ä½¿ã†ã¹ãã‹ã‚’åˆ¤æ–­ã§ãã‚‹å®Ÿè·µçš„ãªèƒ½åŠ›ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

ã€è©³ç´°ãªå‡ºé¡Œå†…å®¹ã€‘
1. å¹³å‡å€¤ï¼ˆç®—è¡“å¹³å‡ï¼‰
   - è¨ˆç®—æ–¹æ³•ï¼šå…¨ãƒ‡ãƒ¼ã‚¿ã®åˆè¨ˆ Ã· ãƒ‡ãƒ¼ã‚¿æ•°
   - ç‰¹å¾´ï¼šå…¨ãƒ‡ãƒ¼ã‚¿ã‚’è€ƒæ…®ã™ã‚‹ãŒã€å¤–ã‚Œå€¤ã®å½±éŸ¿ã‚’å—ã‘ã‚„ã™ã„
   - é©ç”¨å ´é¢ï¼šãƒ‡ãƒ¼ã‚¿ãŒæ­£è¦åˆ†å¸ƒã«è¿‘ãã€æ¥µç«¯ãªå€¤ãŒãªã„å ´åˆ
   - å…·ä½“ä¾‹ï¼šãƒ†ã‚¹ãƒˆã®å¹³å‡ç‚¹ï¼ˆ60, 70, 80, 90, 100ï¼‰â†’ 80ç‚¹

2. ä¸­å¤®å€¤ï¼ˆãƒ¡ã‚¸ã‚¢ãƒ³ï¼‰
   - è¨ˆç®—æ–¹æ³•ï¼šãƒ‡ãƒ¼ã‚¿ã‚’å°ã•ã„é †ã«ä¸¦ã¹ã¦çœŸã‚“ä¸­ã®å€¤ï¼ˆãƒ‡ãƒ¼ã‚¿æ•°ãŒå¶æ•°ã®å ´åˆã¯ä¸­å¤®2ã¤ã®å¹³å‡ï¼‰
   - ç‰¹å¾´ï¼šå¤–ã‚Œå€¤ã®å½±éŸ¿ã‚’å—ã‘ã«ãã„ã€é †åºå°ºåº¦ã«ã‚‚é©ç”¨å¯èƒ½
   - é©ç”¨å ´é¢ï¼šæ‰€å¾—åˆ†å¸ƒãªã©ã€æ¥µç«¯ãªå€¤ãŒã‚ã‚‹å ´åˆ
   - å…·ä½“ä¾‹ï¼šå¹´åï¼ˆ300, 400, 500, 600, 10000ä¸‡å††ï¼‰â†’ ä¸­å¤®å€¤500ä¸‡å††ï¼ˆå¹³å‡2360ä¸‡å††ã‚ˆã‚Šé©åˆ‡ï¼‰

3. æœ€é »å€¤ï¼ˆãƒ¢ãƒ¼ãƒ‰ï¼‰
   - è¨ˆç®—æ–¹æ³•ï¼šæœ€ã‚‚é »ç¹ã«å‡ºç¾ã™ã‚‹å€¤
   - ç‰¹å¾´ï¼šåç¾©å°ºåº¦ã«ã‚‚é©ç”¨å¯èƒ½ã€è¤‡æ•°å­˜åœ¨ã™ã‚‹å ´åˆã‚ã‚Š
   - é©ç”¨å ´é¢ï¼šã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã€é›¢æ•£ãƒ‡ãƒ¼ã‚¿
   - å…·ä½“ä¾‹ï¼šé´ã®ã‚µã‚¤ã‚ºã§æœ€ã‚‚å£²ã‚Œã‚‹ã‚µã‚¤ã‚ºã‚’çŸ¥ã‚ŠãŸã„å ´åˆ

4. åå·®å€¤ã®è¨ˆç®—ã¨è§£é‡ˆ
   - è¨ˆç®—å¼ï¼šåå·®å€¤ = 50 + 10 Ã— (å€‹äººã®å¾—ç‚¹ - å¹³å‡ç‚¹) / æ¨™æº–åå·®
   - æ„å‘³ï¼šå¹³å‡ã‚’50ã€æ¨™æº–åå·®ã‚’10ã«æ¨™æº–åŒ–ã—ãŸå€¤
   - æ´»ç”¨ï¼šç•°ãªã‚‹ãƒ†ã‚¹ãƒˆé–“ã®æˆç¸¾æ¯”è¼ƒã€ç›¸å¯¾çš„ãªä½ç½®ã®æŠŠæ¡
   - å…·ä½“ä¾‹ï¼šå¹³å‡60ç‚¹ã€æ¨™æº–åå·®10ç‚¹ã®ãƒ†ã‚¹ãƒˆã§70ç‚¹ã‚’å–ã£ãŸå ´åˆ â†’ åå·®å€¤60

ã€å•é¡Œã®å…·ä½“ä¾‹ã€‘
ä¾‹1ï¼šã€Œãƒ‡ãƒ¼ã‚¿{10, 20, 30, 40, 1000}ã«ã¤ã„ã¦ã€ãƒ‡ãƒ¼ã‚¿ã®ä¸­å¿ƒã‚’è¡¨ã™ã®ã«æœ€ã‚‚é©åˆ‡ãªä»£è¡¨å€¤ã¯ã©ã‚Œã‹ã€‚ç†ç”±ã‚‚å«ã‚ã¦ç­”ãˆã‚ˆã€
â†’ å¤–ã‚Œå€¤ãŒã‚ã‚‹å ´åˆã®ä»£è¡¨å€¤ã®é¸æŠ

ä¾‹2ï¼šã€Œå¹³å‡ç‚¹70ç‚¹ã€æ¨™æº–åå·®5ç‚¹ã®ãƒ†ã‚¹ãƒˆã§80ç‚¹ã‚’å–ã£ãŸç”Ÿå¾’ã®åå·®å€¤ã¯ã„ãã‚‰ã‹ã€
â†’ åå·®å€¤ã®è¨ˆç®—å•é¡Œ

ä¾‹3ï¼šã€Œå¥½ããªè‰²ã‚’èª¿æŸ»ã—ãŸãƒ‡ãƒ¼ã‚¿ï¼ˆèµ¤15äººã€é’10äººã€é»„5äººã€ç·‘20äººï¼‰ã®ä»£è¡¨å€¤ã¨ã—ã¦é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã‹ã€
â†’ è³ªçš„ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹ä»£è¡¨å€¤ã®é¸æŠ`,
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: åº¦æ•°åˆ†å¸ƒè¡¨ã¨ä»£è¡¨å€¤': {
    grade4: `
ã€å‡ºé¡Œã®èƒŒæ™¯ã¨ç›®çš„ã€‘
å¤šãã®ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ã—ã€ãã®ç‰¹å¾´ã‚’æŠŠæ¡ã™ã‚‹ãŸã‚ã®åŸºæœ¬çš„ãªæ‰‹æ³•ã‚’ç†è§£ã—ã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚åº¦æ•°åˆ†å¸ƒè¡¨ã®ä½œæˆã‹ã‚‰ä»£è¡¨å€¤ã®è¨ˆç®—ã¾ã§ã€ãƒ‡ãƒ¼ã‚¿æ•´ç†ã®åŸºç¤ã‚’èº«ã«ã¤ã‘ã¾ã™ã€‚

ã€è©³ç´°ãªå‡ºé¡Œå†…å®¹ã€‘
1. åº¦æ•°åˆ†å¸ƒè¡¨ã®ä½œæˆ
   - éšç´šã®è¨­å®šï¼šãƒ‡ãƒ¼ã‚¿ã®ç¯„å›²ã‚’é©åˆ‡ãªå¹…ã§åŒºåˆ‡ã‚‹ï¼ˆé€šå¸¸5ã€œ15éšç´šï¼‰
   - éšç´šå¹…ï¼š(æœ€å¤§å€¤ - æœ€å°å€¤) / éšç´šæ•°
   - åº¦æ•°ã®æ•°ãˆä¸Šã’ï¼šå„éšç´šã«å«ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿æ•°ã‚’æ•°ãˆã‚‹
   - å…·ä½“ä¾‹ï¼šãƒ†ã‚¹ãƒˆã®ç‚¹æ•°ï¼ˆ0ã€œ100ç‚¹ï¼‰ã‚’10ç‚¹åˆ»ã¿ã§é›†è¨ˆ

2. åº¦æ•°åˆ†å¸ƒè¡¨ã®èª­ã¿å–ã‚Š
   - å„éšç´šã®åº¦æ•°ï¼ˆãƒ‡ãƒ¼ã‚¿ã®å€‹æ•°ï¼‰ã®ç¢ºèª
   - æœ€ã‚‚åº¦æ•°ãŒå¤šã„éšç´šï¼ˆæœ€é »éšç´šï¼‰ã®ç‰¹å®š
   - åº¦æ•°ã®åˆè¨ˆ = å…¨ãƒ‡ãƒ¼ã‚¿æ•°ã®ç¢ºèª
   - ã‚°ãƒ©ãƒ•ï¼ˆãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ï¼‰ã¨ã®å¯¾å¿œ

3. å¹³å‡å€¤ãƒ»ä¸­å¤®å€¤ãƒ»æœ€é »å€¤ã®è¨ˆç®—
   - å¹³å‡å€¤ï¼šå…¨ãƒ‡ãƒ¼ã‚¿ã®åˆè¨ˆ Ã· ãƒ‡ãƒ¼ã‚¿æ•°
     ä¾‹ï¼š{60, 70, 80, 90, 100}ã®å¹³å‡ = (60+70+80+90+100)/5 = 80
   
   - ä¸­å¤®å€¤ï¼šãƒ‡ãƒ¼ã‚¿ã‚’é †ã«ä¸¦ã¹ãŸã¨ãã®çœŸã‚“ä¸­ã®å€¤
     ä¾‹ï¼š{60, 70, 80, 90, 100}ã®ä¸­å¤®å€¤ = 80
     ä¾‹ï¼š{60, 70, 80, 90}ã®ä¸­å¤®å€¤ = (70+80)/2 = 75
   
   - æœ€é »å€¤ï¼šæœ€ã‚‚å¤šãå‡ºç¾ã™ã‚‹å€¤
     ä¾‹ï¼š{60, 70, 70, 80, 90}ã®æœ€é »å€¤ = 70

4. åº¦æ•°åˆ†å¸ƒè¡¨ã‹ã‚‰ã®ä»£è¡¨å€¤ã®æ¨å®š
   - éšç´šå€¤ï¼šå„éšç´šã®ä¸­å¤®ã®å€¤ï¼ˆéšç´šã®ä¸‹é™+ä¸Šé™ï¼‰/2
   - å¹³å‡å€¤ã®æ¨å®šï¼š(éšç´šå€¤ Ã— åº¦æ•°)ã®åˆè¨ˆ / å…¨åº¦æ•°
   - ä¸­å¤®å€¤ã®æ¨å®šï¼šç´¯ç©åº¦æ•°ãŒå…¨ä½“ã®åŠåˆ†ã‚’è¶…ãˆã‚‹éšç´š

ã€å•é¡Œã®å…·ä½“ä¾‹ã€‘
ä¾‹1ï¼šã€Œæ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’10ç‚¹åˆ»ã¿ã®éšç´šã§åº¦æ•°åˆ†å¸ƒè¡¨ã‚’ä½œæˆã›ã‚ˆï¼š{52, 68, 73, 81, 65, 77, 90, 58, 74, 82}ã€
â†’ åº¦æ•°åˆ†å¸ƒè¡¨ã®ä½œæˆå•é¡Œ

ä¾‹2ï¼šã€Œãƒ‡ãƒ¼ã‚¿{3, 5, 5, 7, 9, 11}ã®å¹³å‡å€¤ã€ä¸­å¤®å€¤ã€æœ€é »å€¤ã‚’æ±‚ã‚ã‚ˆã€
â†’ 3ã¤ã®ä»£è¡¨å€¤ã®è¨ˆç®—

ä¾‹3ï¼šã€Œæ¬¡ã®åº¦æ•°åˆ†å¸ƒè¡¨ã‹ã‚‰ã€ãƒ‡ãƒ¼ã‚¿ã®ä¸­å¿ƒå‚¾å‘ã«ã¤ã„ã¦è¿°ã¹ã‚ˆã€
â†’ åº¦æ•°åˆ†å¸ƒè¡¨ã®èª­è§£å•é¡Œ`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: æ•£ã‚‰ã°ã‚Šã®æŒ‡æ¨™': {
    grade3: `ç¯„å›²ãƒ»å››åˆ†ä½ç¯„å›²ã®è¨ˆç®—ã€æ¨™æº–åå·®ãƒ»åˆ†æ•£ã®è¨ˆç®—ã¨è§£é‡ˆã€å¤‰å‹•ä¿‚æ•°ã®è¨ˆç®—ã¨æ„å‘³ã€æ•£ã‚‰ã°ã‚Šã®æŒ‡æ¨™ã®ä½¿ã„åˆ†ã‘ã‚’å•ã†å•é¡Œ`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: åº¦æ•°åˆ†å¸ƒè¡¨ã®å¿œç”¨': {
    grade4: `ç´¯ç©åº¦æ•°ãƒ»ç´¯ç©ç›¸å¯¾åº¦æ•°ã®è¨ˆç®—ã¨èª­ã¿å–ã‚Šã€ç›¸å¯¾åº¦æ•°ã®è¨ˆç®—ã¨æ„å‘³ã€éšç´šå€¤ã‚’ç”¨ã„ãŸå¹³å‡å€¤ã®è¨ˆç®—ã€åº¦æ•°åˆ†å¸ƒè¡¨ã®å¿œç”¨çš„ãªèª­è§£`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: ç®±ã²ã’å›³ã¨ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ': {
    grade3: `5æ•°è¦ç´„ï¼ˆæœ€å°å€¤ã€Q1ã€ä¸­å¤®å€¤ã€Q3ã€æœ€å¤§å€¤ï¼‰ã®è¨ˆç®—ã€ç®±ã²ã’å›³ã®ä½œæˆã¨èª­ã¿å–ã‚Šã€ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã®èª­ã¿å–ã‚Šã€åº¦æ•°åˆ†å¸ƒè¡¨ã¨ã®å¯¾å¿œé–¢ä¿‚`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: ã‚°ãƒ©ãƒ•ã®èª­è§£': {
    grade4: `æ£’ã‚°ãƒ©ãƒ•ãƒ»å††ã‚°ãƒ©ãƒ•ãƒ»æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ãƒ»ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã®èª­ã¿å–ã‚Šã€ã‚°ãƒ©ãƒ•é–“ã®æ¯”è¼ƒã€ã‚°ãƒ©ãƒ•ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹æƒ…å ±ã¨èª­ã¿å–ã‚Œãªã„æƒ…å ±ã®åŒºåˆ¥`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³5: æ•£å¸ƒå›³ã¨ç›¸é–¢': {
    grade3: `
ã€å‡ºé¡Œã®èƒŒæ™¯ã¨ç›®çš„ã€‘
2ã¤ã®å¤‰æ•°ã®é–¢ä¿‚æ€§ã‚’è¦–è¦šçš„ã«æŠŠæ¡ã—ã€æ•°å€¤ã§å®šé‡åŒ–ã™ã‚‹ã“ã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿åˆ†æã®é‡è¦ãªã‚¹ã‚­ãƒ«ã§ã™ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ç›¸é–¢ã®æ¦‚å¿µã‚’æ­£ã—ãç†è§£ã—ã€å› æœé–¢ä¿‚ã¨æ··åŒã—ãªã„æ‰¹åˆ¤çš„æ€è€ƒåŠ›ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

ã€è©³ç´°ãªå‡ºé¡Œå†…å®¹ã€‘
1. æ•£å¸ƒå›³ã®ä½œæˆã¨èª­ã¿å–ã‚Š
   - æ¨ªè»¸ï¼ˆxè»¸ï¼‰ã«èª¬æ˜å¤‰æ•°ã€ç¸¦è»¸ï¼ˆyè»¸ï¼‰ã«ç›®çš„å¤‰æ•°ã‚’ãƒ—ãƒ­ãƒƒãƒˆ
   - æ•£å¸ƒå›³ã®ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜
     ãƒ»æ­£ã®ç›¸é–¢ï¼šå³ä¸ŠãŒã‚Šã®å‚¾å‘ï¼ˆä¸€æ–¹ãŒå¢—ãˆã‚‹ã¨ã‚‚ã†ä¸€æ–¹ã‚‚å¢—ãˆã‚‹ï¼‰
     ãƒ»è² ã®ç›¸é–¢ï¼šå³ä¸‹ãŒã‚Šã®å‚¾å‘ï¼ˆä¸€æ–¹ãŒå¢—ãˆã‚‹ã¨ã‚‚ã†ä¸€æ–¹ã¯æ¸›ã‚‹ï¼‰
     ãƒ»ç„¡ç›¸é–¢ï¼šæ˜ç¢ºãªå‚¾å‘ãŒè¦‹ã‚‰ã‚Œãªã„
   - å¤–ã‚Œå€¤ã®è­˜åˆ¥ã¨å½±éŸ¿ã®è©•ä¾¡
   - å…·ä½“ä¾‹ï¼šèº«é•·ã¨ä½“é‡ï¼ˆæ­£ã®ç›¸é–¢ï¼‰ã€æ°—æ¸©ã¨ã‚³ãƒ¼ãƒˆå£²ä¸Šï¼ˆè² ã®ç›¸é–¢ï¼‰

2. ç›¸é–¢ä¿‚æ•°ã®è¨ˆç®—ã¨è§£é‡ˆ
   - ç›¸é–¢ä¿‚æ•°r ã®ç¯„å›²ï¼š-1 â‰¤ r â‰¤ 1
   - ç›¸é–¢ä¿‚æ•°ã®æ„å‘³
     ãƒ»r = 1ï¼šå®Œå…¨ãªæ­£ã®ç›¸é–¢ï¼ˆç›´ç·šä¸Šã«ä¸¦ã¶ï¼‰
     ãƒ»r = 0ï¼šç„¡ç›¸é–¢
     ãƒ»r = -1ï¼šå®Œå…¨ãªè² ã®ç›¸é–¢
     ãƒ»|r| > 0.7ï¼šå¼·ã„ç›¸é–¢ã€0.4 < |r| < 0.7ï¼šä¸­ç¨‹åº¦ã®ç›¸é–¢ã€|r| < 0.4ï¼šå¼±ã„ç›¸é–¢
   - è¨ˆç®—å¼ï¼šr = (å…±åˆ†æ•£) / (xã®æ¨™æº–åå·® Ã— yã®æ¨™æº–åå·®)
   - å…·ä½“ä¾‹ï¼šå‹‰å¼·æ™‚é–“ã¨æˆç¸¾ï¼ˆr = 0.6ç¨‹åº¦ã®æ­£ã®ç›¸é–¢ï¼‰

3. ç›¸é–¢ã¨å› æœé–¢ä¿‚ã®é•ã„
   - ç›¸é–¢é–¢ä¿‚ï¼š2ã¤ã®å¤‰æ•°ã«é–¢é€£æ€§ãŒã‚ã‚‹
   - å› æœé–¢ä¿‚ï¼šä¸€æ–¹ãŒåŸå› ã§ä»–æ–¹ãŒçµæœ
   - ç›¸é–¢â‰ å› æœã®é‡è¦æ€§ï¼šç›¸é–¢ãŒã‚ã£ã¦ã‚‚å› æœã¨ã¯é™ã‚‰ãªã„
   - ç¬¬ä¸‰ã®å¤‰æ•°ã«ã‚ˆã‚‹ç–‘ä¼¼ç›¸é–¢ã®ä¾‹
     ä¾‹ï¼šã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ã®å£²ä¸Šã¨æ°´é›£äº‹æ•…ï¼ˆå®Ÿã¯æ°—æ¸©ã¨ã„ã†ç¬¬ä¸‰ã®å¤‰æ•°ãŒåŸå› ï¼‰
     ä¾‹ï¼šã‚³ã‚¦ãƒãƒˆãƒªã®æ•°ã¨å‡ºç”Ÿç‡ï¼ˆå®Ÿã¯éƒ½å¸‚åŒ–ãƒ»äººå£ã¨ã„ã†ç¬¬ä¸‰ã®å¤‰æ•°ï¼‰

4. ç–‘ä¼¼ç›¸é–¢ã®ç†è§£ã¨æ³¨æ„ç‚¹
   - å¶ç„¶ã®ç›¸é–¢ï¼šãŸã¾ãŸã¾é–¢é€£ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
   - äº¤çµ¡å› å­ï¼šéš ã‚ŒãŸç¬¬ä¸‰ã®å¤‰æ•°ã®å­˜åœ¨
   - ãƒ‡ãƒ¼ã‚¿è§£é‡ˆã«ãŠã‘ã‚‹æ‰¹åˆ¤çš„æ€è€ƒã®é‡è¦æ€§
   - å®Ÿé¨“è¨ˆç”»ã«ã‚ˆã‚‹å› æœé–¢ä¿‚ã®æ¤œè¨¼æ–¹æ³•

ã€å•é¡Œã®å…·ä½“ä¾‹ã€‘
ä¾‹1ï¼šã€Œã‚ã‚‹åœ°åŸŸã§ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ã®å£²ä¸Šã¨æ°´é›£äº‹æ•…ã®ä»¶æ•°ã«å¼·ã„æ­£ã®ç›¸é–¢ãŒè¦‹ã‚‰ã‚ŒãŸã€‚ã“ã‚Œã¯å› æœé–¢ä¿‚ã¨è¨€ãˆã‚‹ã‹ï¼Ÿç†ç”±ã‚‚å«ã‚ã¦ç­”ãˆã‚ˆã€
â†’ ç–‘ä¼¼ç›¸é–¢ã®ç†è§£

ä¾‹2ï¼šã€Œç›¸é–¢ä¿‚æ•°ãŒ r = -0.85 ã§ã‚ã‚‹2ã¤ã®å¤‰æ•°ã®é–¢ä¿‚ã‚’èª¬æ˜ã›ã‚ˆã€
â†’ ç›¸é–¢ä¿‚æ•°ã®è§£é‡ˆ

ä¾‹3ï¼šã€Œå‹‰å¼·æ™‚é–“ã¨æˆç¸¾ã€æ°—æ¸©ã¨ã‚³ãƒ¼ãƒˆå£²ä¸Šã€èº«é•·ã¨èª•ç”Ÿæœˆã«ã¤ã„ã¦ã€ãã‚Œãã‚Œç›¸é–¢ãŒã‚ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã‚‹ã‹ã€
â†’ ç›¸é–¢ã®æœ‰ç„¡ã®åˆ¤æ–­`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³5: ç¢ºç‡': {
    grade4: `
ã€å‡ºé¡Œã®èƒŒæ™¯ã¨ç›®çš„ã€‘
ç¢ºç‡ã¯æ—¥å¸¸ç”Ÿæ´»ã®æ§˜ã€…ãªå ´é¢ã§ä½¿ã‚ã‚Œã‚‹é‡è¦ãªæ¦‚å¿µã§ã™ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€åŸºæœ¬çš„ãªç¢ºç‡è¨ˆç®—ã‹ã‚‰ã€å ´åˆã®æ•°ã®æ•°ãˆæ–¹ã€ç‹¬ç«‹äº‹è±¡ã®ç†è§£ã¾ã§ã€ç¢ºç‡çš„æ€è€ƒã®åŸºç¤ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

ã€è©³ç´°ãªå‡ºé¡Œå†…å®¹ã€‘
1. ç¢ºç‡ã®åŸºæœ¬è¨ˆç®—
   - ç¢ºç‡ã®å®šç¾©ï¼šç¢ºç‡ = (ã‚ã‚‹äº‹è±¡ãŒèµ·ã“ã‚‹å ´åˆã®æ•°) / (ã™ã¹ã¦ã®å ´åˆã®æ•°)
   - ã‚µã‚¤ã‚³ãƒ­ã®ä¾‹
     ãƒ»1ã®ç›®ãŒå‡ºã‚‹ç¢ºç‡ = 1/6
     ãƒ»å¶æ•°ã®ç›®ãŒå‡ºã‚‹ç¢ºç‡ = 3/6 = 1/2
     ãƒ»4ä»¥ä¸Šã®ç›®ãŒå‡ºã‚‹ç¢ºç‡ = 3/6 = 1/2
   
   - ã‚³ã‚¤ãƒ³ã®ä¾‹
     ãƒ»è¡¨ãŒå‡ºã‚‹ç¢ºç‡ = 1/2
     ãƒ»2å›æŠ•ã’ã¦ä¸¡æ–¹è¡¨ã®ç¢ºç‡ = 1/2 Ã— 1/2 = 1/4
   
   - ãã˜å¼•ãã®ä¾‹
     ãƒ»10æœ¬ä¸­3æœ¬å½“ãŸã‚Šã®å ´åˆã€å½“ãŸã‚‹ç¢ºç‡ = 3/10

2. å ´åˆã®æ•°ã®æ•°ãˆæ–¹
   - æ¨¹å½¢å›³ã‚’ä½¿ã£ãŸæ•°ãˆä¸Šã’
     ä¾‹ï¼šã‚³ã‚¤ãƒ³ã‚’2å›æŠ•ã’ã‚‹ â†’ è¡¨è¡¨ã€è¡¨è£ã€è£è¡¨ã€è£è£ã®4é€šã‚Š
   
   - æ›ã‘ç®—ã®åŸç†
     ä¾‹ï¼šã‚·ãƒ£ãƒ„3ç¨®é¡Ã—ã‚ºãƒœãƒ³2ç¨®é¡ = 6é€šã‚Šã®çµ„ã¿åˆã‚ã›
   
   - é †åˆ—ã®åŸºç¤ï¼ˆä¸¦ã¹æ–¹ï¼‰
     ä¾‹ï¼šA, B, C ã®3äººã®ä¸¦ã¹æ–¹ = 3Ã—2Ã—1 = 6é€šã‚Š
   
   - çµ„åˆã›ã®åŸºç¤ï¼ˆé¸ã³æ–¹ï¼‰
     ä¾‹ï¼š5äººã‹ã‚‰2äººé¸ã¶ = 10é€šã‚Š

3. ç‹¬ç«‹äº‹è±¡ã®ç¢ºç‡
   - ç‹¬ç«‹äº‹è±¡ï¼šä¸€æ–¹ã®çµæœãŒä»–æ–¹ã«å½±éŸ¿ã—ãªã„
     ä¾‹ï¼šã‚µã‚¤ã‚³ãƒ­ã‚’2å›æŒ¯ã‚‹ã€ç•°ãªã‚‹ã‚³ã‚¤ãƒ³ã‚’æŠ•ã’ã‚‹
   
   - ç‹¬ç«‹äº‹è±¡ã®ç¢ºç‡ã®ä¹—æ³•å®šç†
     P(A ã‹ã¤ B) = P(A) Ã— P(B)
     ä¾‹ï¼šã‚µã‚¤ã‚³ãƒ­ã§1ãŒå‡ºã¦(1/6)ã€ã‚³ã‚¤ãƒ³ã§è¡¨ãŒå‡ºã‚‹(1/2) â†’ 1/6 Ã— 1/2 = 1/12
   
   - éç‹¬ç«‹äº‹è±¡ã¨ã®é•ã„
     ä¾‹ï¼šã‚«ãƒ¼ãƒ‰ã‚’æˆ»ã•ãšã«å¼•ãå ´åˆ

4. ç¢ºç‡ã®åŠ æ³•å®šç†
   - æ’åäº‹è±¡ï¼ˆåŒæ™‚ã«èµ·ã“ã‚‰ãªã„ï¼‰ï¼šP(A ã¾ãŸã¯ B) = P(A) + P(B)
     ä¾‹ï¼šã‚µã‚¤ã‚³ãƒ­ã§1ã¾ãŸã¯2ãŒå‡ºã‚‹ç¢ºç‡ = 1/6 + 1/6 = 1/3
   
   - ä½™äº‹è±¡ã®åˆ©ç”¨ï¼šP(A) = 1 - P(Aã§ãªã„)
     ä¾‹ï¼šå°‘ãªãã¨ã‚‚1å›è¡¨ãŒå‡ºã‚‹ç¢ºç‡ = 1 - (å…¨éƒ¨è£ã®ç¢ºç‡)

ã€å•é¡Œã®å…·ä½“ä¾‹ã€‘
ä¾‹1ï¼šã€Œã‚µã‚¤ã‚³ãƒ­ã‚’2å›æŒ¯ã£ã¦ã€ä¸¡æ–¹ã¨ã‚‚3ä»¥ä¸Šã®ç›®ãŒå‡ºã‚‹ç¢ºç‡ã‚’æ±‚ã‚ã‚ˆã€
â†’ ç‹¬ç«‹äº‹è±¡ã®ä¹—æ³•å®šç†

ä¾‹2ï¼šã€Œ10æœ¬ã®ãã˜ã®ä¸­ã«å½“ãŸã‚ŠãŒ2æœ¬ã‚ã‚‹ã€‚2æœ¬å¼•ã„ã¦ï¼ˆæˆ»ã•ãªã„ï¼‰ã€å°‘ãªãã¨ã‚‚1æœ¬å½“ãŸã‚‹ç¢ºç‡ã‚’æ±‚ã‚ã‚ˆã€
â†’ ä½™äº‹è±¡ã®åˆ©ç”¨

ä¾‹3ï¼šã€Œèµ¤ç‰3å€‹ã€ç™½ç‰2å€‹ãŒå…¥ã£ãŸè¢‹ã‹ã‚‰2å€‹åŒæ™‚ã«å–ã‚Šå‡ºã™ã¨ãã€2å€‹ã¨ã‚‚èµ¤ç‰ã§ã‚ã‚‹ç¢ºç‡ã‚’æ±‚ã‚ã‚ˆã€
â†’ çµ„åˆã›ã¨ç¢ºç‡`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³6: ã‚¯ãƒ­ã‚¹é›†è¨ˆè¡¨': {
    grade3: `ã‚¯ãƒ­ã‚¹é›†è¨ˆè¡¨ã®ä½œæˆã¨èª­ã¿å–ã‚Šã€è¡Œãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆãƒ»åˆ—ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã®è¨ˆç®—ã€æ¡ä»¶ä»˜ãç¢ºç‡ã®è¨ˆç®—ã€2å¤‰æ•°ã®é–¢ä¿‚æ€§ã®åˆ†æ`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³6: æ•£å¸ƒå›³ã¨ç›¸é–¢': {
    grade4: `æ•£å¸ƒå›³ã®èª­ã¿å–ã‚Šã€æ­£ã®ç›¸é–¢ãƒ»è² ã®ç›¸é–¢ãƒ»ç„¡ç›¸é–¢ã®è­˜åˆ¥ã€ç›¸é–¢ã®å¼·ã•ã®åˆ¤æ–­ã€æ•£å¸ƒå›³ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹å‚¾å‘`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³7: ç¢ºç‡ã®åŸºç¤': {
    grade3: `ç¢ºç‡ã®è¨ˆç®—ï¼ˆæ¡ä»¶ä»˜ãç¢ºç‡ã‚’å«ã‚€ï¼‰ã€æœŸå¾…å€¤ã®è¨ˆç®—ã¨æ„å‘³ã€ç¢ºç‡åˆ†å¸ƒã®åŸºç¤ã€æ¨¹å½¢å›³ã‚’ç”¨ã„ãŸç¢ºç‡è¨ˆç®—`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³7: ç®±ã²ã’å›³': {
    grade4: `ç®±ã²ã’å›³ã®æ§‹æˆè¦ç´ ï¼ˆæœ€å°å€¤ã€Q1ã€ä¸­å¤®å€¤ã€Q3ã€æœ€å¤§å€¤ï¼‰ã€5æ•°è¦ç´„ã®ç†è§£ã€å››åˆ†ä½ç¯„å›²ã®è¨ˆç®—ã€ç®±ã²ã’å›³ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã®åˆ†å¸ƒã‚’èª­ã¿å–ã‚‹`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³8: æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã¨æŒ‡æ•°': {
    grade3: `æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•ã®èª­ã¿å–ã‚Šã€å¤‰åŒ–ç‡ï¼ˆå¢—åŠ ç‡ãƒ»æ¸›å°‘ç‡ï¼‰ã®è¨ˆç®—ã€æŒ‡æ•°ï¼ˆåŸºæº–å¹´ã‚’100ã¨ã™ã‚‹ï¼‰ã®è¨ˆç®—ã¨è§£é‡ˆã€å¯¾å‰å¹´æ¯”ã®è¨ˆç®—`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³8: ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ': {
    grade4: `ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã®ä½œæˆã¨èª­ã¿å–ã‚Šã€éšç´šã¨åº¦æ•°ã®é–¢ä¿‚ã€åˆ†å¸ƒã®å½¢çŠ¶ï¼ˆå·¦å³å¯¾ç§°ãƒ»å³ã«æ­ªã¿ãƒ»å·¦ã«æ­ªã¿ï¼‰ã®ç†è§£ã€ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã¨åº¦æ•°åˆ†å¸ƒè¡¨ã®å¯¾å¿œ`
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³9: æ¨™æœ¬èª¿æŸ»ã¨å®Ÿé¨“è¨ˆç”»': {
    grade3: `
ã€å‡ºé¡Œã®èƒŒæ™¯ã¨ç›®çš„ã€‘
æ¯é›†å›£å…¨ä½“ã‚’èª¿æŸ»ã™ã‚‹ã“ã¨ã¯å¤šãã®å ´åˆä¸å¯èƒ½ãªãŸã‚ã€æ¨™æœ¬ã‹ã‚‰æ¯é›†å›£ã‚’æ¨æ¸¬ã™ã‚‹æ‰‹æ³•ãŒé‡è¦ã§ã™ã€‚ã¾ãŸã€å› æœé–¢ä¿‚ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹ã«ã¯é©åˆ‡ãªå®Ÿé¨“è¨ˆç”»ãŒå¿…è¦ã§ã™ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€çµ±è¨ˆçš„æ¨æ¸¬ã®åŸºç¤ã¨ç§‘å­¦çš„ãªå®Ÿé¨“æ‰‹æ³•ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

ã€è©³ç´°ãªå‡ºé¡Œå†…å®¹ã€‘
1. æ¯é›†å›£ã¨æ¨™æœ¬ã®æ¦‚å¿µ
   - æ¯é›†å›£ï¼šèª¿æŸ»å¯¾è±¡ã®å…¨ä½“é›†åˆ
     ä¾‹ï¼šæ—¥æœ¬ã®å…¨æœ‰æ¨©è€…ã€ã‚ã‚‹å·¥å ´ã§ç”Ÿç”£ã•ã‚Œã‚‹å…¨è£½å“
   - æ¨™æœ¬ï¼šæ¯é›†å›£ã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸä¸€éƒ¨
     ä¾‹ï¼š1000äººã®æœ‰æ¨©è€…ã€100å€‹ã®è£½å“ã‚µãƒ³ãƒ—ãƒ«
   - æ¨™æœ¬èª¿æŸ»ã®ç›®çš„ï¼šæ¨™æœ¬ã‹ã‚‰æ¯é›†å›£ã®ç‰¹æ€§ã‚’æ¨æ¸¬
   - å…¨æ•°èª¿æŸ»vsæ¨™æœ¬èª¿æŸ»ã®æ¯”è¼ƒ
     ãƒ»å…¨æ•°èª¿æŸ»ï¼šæ­£ç¢ºã ãŒæ™‚é–“ãƒ»è²»ç”¨ãŒã‹ã‹ã‚‹ï¼ˆä¾‹ï¼šå›½å‹¢èª¿æŸ»ï¼‰
     ãƒ»æ¨™æœ¬èª¿æŸ»ï¼šè¿…é€Ÿãƒ»çµŒæ¸ˆçš„ã ãŒæ¨æ¸¬èª¤å·®ãŒã‚ã‚‹ï¼ˆä¾‹ï¼šä¸–è«–èª¿æŸ»ï¼‰

2. æ¨™æœ¬æŠ½å‡ºæ³•
   - ç„¡ä½œç‚ºæŠ½å‡ºï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰
     ãƒ»åŸç†ï¼šæ¯é›†å›£ã®å„è¦ç´ ãŒç­‰ã—ã„ç¢ºç‡ã§é¸ã°ã‚Œã‚‹
     ãƒ»æ–¹æ³•ï¼šä¹±æ•°è¡¨ã€ãã˜å¼•ãã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã«ã‚ˆã‚‹ä¹±æ•°ç”Ÿæˆ
     ãƒ»é‡è¦æ€§ï¼šåã‚Šã®ãªã„æ¨æ¸¬ãŒå¯èƒ½
   
   - å±¤åˆ¥æŠ½å‡ºï¼ˆStratified Samplingï¼‰
     ãƒ»æ¯é›†å›£ã‚’å±¤ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã«åˆ†ã‘ã¦ã€å„å±¤ã‹ã‚‰ç„¡ä½œç‚ºæŠ½å‡º
     ãƒ»ä¾‹ï¼šå¹´é½¢å±¤åˆ¥ã€åœ°åŸŸåˆ¥ã«åˆ†ã‘ã¦æŠ½å‡º
     ãƒ»åˆ©ç‚¹ï¼šå„å±¤ã®ç‰¹æ€§ã‚’åæ˜ ã§ãã€ç²¾åº¦ãŒå‘ä¸Š
   
   - ç³»çµ±æŠ½å‡ºï¼ˆSystematic Samplingï¼‰
     ãƒ»ä¸€å®šé–“éš”ã§æŠ½å‡ºï¼ˆä¾‹ï¼š10äººã”ã¨ã«1äººé¸ã¶ï¼‰
     ãƒ»åˆ©ç‚¹ï¼šå®Ÿæ–½ãŒç°¡å˜
     ãƒ»æ³¨æ„ï¼šå‘¨æœŸæ€§ãŒã‚ã‚‹å ´åˆã¯åã‚ŠãŒç”Ÿã˜ã‚‹å¯èƒ½æ€§

3. å®Ÿé¨“ãƒ‡ã‚¶ã‚¤ãƒ³ã®åŸºæœ¬
   - å¯¾ç…§ç¾¤ã¨å®Ÿé¨“ç¾¤
     ãƒ»å¯¾ç…§ç¾¤ï¼šå‡¦ç†ã‚’å—ã‘ãªã„ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆæ¯”è¼ƒã®åŸºæº–ï¼‰
     ãƒ»å®Ÿé¨“ç¾¤ï¼šå‡¦ç†ã‚’å—ã‘ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—
     ãƒ»ä¾‹ï¼šæ–°è–¬ã®åŠ¹æœæ¤œè¨¼ï¼ˆå¯¾ç…§ç¾¤ï¼šæ—¢å­˜è–¬ã¾ãŸã¯å½è–¬ã€å®Ÿé¨“ç¾¤ï¼šæ–°è–¬ï¼‰
   
   - ç„¡ä½œç‚ºåŒ–ï¼ˆRandomizationï¼‰
     ãƒ»è¢«é¨“è€…ã‚’ç„¡ä½œç‚ºã«ç¾¤ã«å‰²ã‚Šå½“ã¦ã‚‹
     ãƒ»ç›®çš„ï¼šæ—¢çŸ¥ãƒ»æœªçŸ¥ã®äº¤çµ¡å› å­ã®å½±éŸ¿ã‚’å‡ç­‰åŒ–
   
   - ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰æ³•
     ãƒ»å˜ç›²æ¤œï¼šè¢«é¨“è€…ãŒå‰²ã‚Šå½“ã¦ã‚’çŸ¥ã‚‰ãªã„
     ãƒ»äºŒé‡ç›²æ¤œï¼šè¢«é¨“è€…ã‚‚ç ”ç©¶è€…ã‚‚çŸ¥ã‚‰ãªã„
     ãƒ»ç›®çš„ï¼šãƒ—ãƒ©ã‚»ãƒœåŠ¹æœã‚„è©•ä¾¡è€…ãƒã‚¤ã‚¢ã‚¹ã®é™¤å»

4. ãƒã‚¤ã‚¢ã‚¹ã¨ãã®å›é¿æ–¹æ³•
   - é¸æŠãƒã‚¤ã‚¢ã‚¹ï¼šæ¨™æœ¬æŠ½å‡ºã®éç¨‹ã§ç”Ÿã˜ã‚‹åã‚Š
     ä¾‹ï¼šé›»è©±èª¿æŸ»ï¼ˆå›ºå®šé›»è©±ã‚’æŒãŸãªã„å±¤ãŒé™¤å¤–ã•ã‚Œã‚‹ï¼‰
   
   - æ¸¬å®šãƒã‚¤ã‚¢ã‚¹ï¼šãƒ‡ãƒ¼ã‚¿åé›†éç¨‹ã§ã®åã‚Š
     ä¾‹ï¼šèª˜å°çš„ãªè³ªå•ã€è¦³å¯Ÿè€…ã®ä¸»è¦³
   
   - éå›ç­”ãƒã‚¤ã‚¢ã‚¹ï¼šå›ç­”ã—ãªã„äººã«åã‚ŠãŒã‚ã‚‹
     ä¾‹ï¼šå¿™ã—ã„äººã€é–¢å¿ƒã®ãªã„äººãŒå›ç­”ã—ãªã„
   
   - å›é¿æ–¹æ³•ï¼šé©åˆ‡ãªæŠ½å‡ºæ³•ã€æ¨™æº–åŒ–ã•ã‚ŒãŸæ¸¬å®šã€è¿½è·¡èª¿æŸ»

ã€å•é¡Œã®å…·ä½“ä¾‹ã€‘
ä¾‹1ï¼šã€Œã‚ã‚‹å¸‚ã®ä½æ°‘10ä¸‡äººã®å¹³å‡æ‰€å¾—ã‚’èª¿æŸ»ã—ãŸã„ã€‚å…¨å“¡ã‚’èª¿æŸ»ã™ã‚‹ã®ã¯å›°é›£ãªãŸã‚ã€1000äººã‚’æŠ½å‡ºã—ã¦èª¿æŸ»ã™ã‚‹ã€‚ã“ã®å ´åˆã€æ¯é›†å›£ã¨æ¨™æœ¬ã¯ãã‚Œãã‚Œä½•ã‹ã€
â†’ æ¯é›†å›£ã¨æ¨™æœ¬ã®è­˜åˆ¥

ä¾‹2ï¼šã€Œæ–°ã—ã„å­¦ç¿’æ–¹æ³•ã®åŠ¹æœã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¹ã‚’2ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†ã‘ãŸã€‚ã‚°ãƒ«ãƒ¼ãƒ—Aã¯æ–°ã—ã„æ–¹æ³•ã€ã‚°ãƒ«ãƒ¼ãƒ—Bã¯å¾“æ¥ã®æ–¹æ³•ã§å­¦ç¿’ã•ã›ãŸã€‚ã“ã®å®Ÿé¨“ã®å•é¡Œç‚¹ã‚’æŒ‡æ‘˜ã—ã€æ”¹å–„æ–¹æ³•ã‚’ææ¡ˆã›ã‚ˆã€
â†’ å®Ÿé¨“ãƒ‡ã‚¶ã‚¤ãƒ³ã®è©•ä¾¡ã¨æ”¹å–„

ä¾‹3ï¼šã€Œã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆèª¿æŸ»ã§ã€ã‚ãªãŸã¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚’ä½¿ã£ã¦ã„ã¾ã™ã‹ï¼Ÿã€ã¨è³ªå•ã—ãŸçµæœã€99%ãŒã€ã¯ã„ã€ã¨å›ç­”ã—ãŸã€‚ã“ã®çµæœã‹ã‚‰ã€å›½æ°‘ã®99%ãŒã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚’ä½¿ã£ã¦ã„ã‚‹ã€ã¨çµè«–ã§ãã‚‹ã‹ã€
â†’ æ¨™æœ¬æŠ½å‡ºãƒã‚¤ã‚¢ã‚¹ã®ç†è§£`,
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³9: æ¨™æœ¬èª¿æŸ»': {
    grade4: `
ã€å‡ºé¡Œã®èƒŒæ™¯ã¨ç›®çš„ã€‘
ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª¿æŸ»ã™ã‚‹ã“ã¨ã¯ç¾å®Ÿçš„ã§ãªã„ãŸã‚ã€ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å…¨ä½“ã‚’æ¨æ¸¬ã™ã‚‹æ¨™æœ¬èª¿æŸ»ã®åŸºç¤ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€æ¨™æœ¬èª¿æŸ»ã®åŸºæœ¬æ¦‚å¿µã¨ãã®æ³¨æ„ç‚¹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

ã€è©³ç´°ãªå‡ºé¡Œå†…å®¹ã€‘
1. æ¯é›†å›£ã¨æ¨™æœ¬ã®æ¦‚å¿µ
   - æ¯é›†å›£ï¼šçŸ¥ã‚ŠãŸã„å¯¾è±¡ã®å…¨ä½“
     ä¾‹ï¼šæ—¥æœ¬ã®å…¨ä¸­å­¦ç”Ÿã€ã‚ã‚‹æ± ã®å…¨ã¦ã®é­šã€å·¥å ´ã§ä½œã‚‰ã‚Œã‚‹å…¨è£½å“
   
   - æ¨™æœ¬ï¼šæ¯é›†å›£ã‹ã‚‰é¸ã°ã‚ŒãŸä¸€éƒ¨
     ä¾‹ï¼š1000äººã®ä¸­å­¦ç”Ÿã€50åŒ¹ã®é­šã€100å€‹ã®è£½å“
   
   - æ¨™æœ¬ã‚’ä½¿ã†ç†ç”±
     ãƒ»æ™‚é–“ã¨è²»ç”¨ã®ç¯€ç´„
     ãƒ»ç ´å£Šæ¤œæŸ»ã®å ´åˆï¼ˆå…¨éƒ¨èª¿ã¹ã‚‹ã¨è£½å“ãŒãªããªã‚‹ï¼‰
     ãƒ»èª¿æŸ»ãŒä¸å¯èƒ½ãªå ´åˆï¼ˆä¾‹ï¼šå®‡å®™ã®æ˜Ÿã®æ•°ï¼‰

2. ç„¡ä½œç‚ºæŠ½å‡ºã®é‡è¦æ€§
   - ç„¡ä½œç‚ºæŠ½å‡ºï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰ï¼šæ¯é›†å›£ã®ã©ã®è¦ç´ ã‚‚ç­‰ã—ã„ç¢ºç‡ã§é¸ã°ã‚Œã‚‹
     æ–¹æ³•ï¼šãã˜å¼•ãã€ä¹±æ•°è¡¨ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ä¹±æ•°
   
   - ãªãœç„¡ä½œç‚ºæŠ½å‡ºãŒé‡è¦ã‹
     ãƒ»åã‚ŠãŒãªã„æ¨™æœ¬ãŒå¾—ã‚‰ã‚Œã‚‹
     ãƒ»çµ±è¨ˆçš„ãªæ¨æ¸¬ãŒå¯èƒ½ã«ãªã‚‹
     ãƒ»ç‰¹å®šã®ã‚°ãƒ«ãƒ¼ãƒ—ã«åã‚‰ãªã„
   
   - å…·ä½“ä¾‹ï¼šã‚¯ãƒ©ã‚¹å…¨å“¡ã‹ã‚‰10äººé¸ã¶ã¨ã
     â—‹ ãã˜å¼•ãã§é¸ã¶
     Ã— å‡ºå¸­ç•ªå·ã®å‰ã‹ã‚‰10äººï¼ˆåã‚ŠãŒã‚ã‚‹ï¼‰
     Ã— æ‰‹ã‚’æŒ™ã’ãŸäººã‹ã‚‰10äººï¼ˆåã‚ŠãŒã‚ã‚‹ï¼‰

3. æ¨™æœ¬èª¿æŸ»ã®ãƒã‚¤ã‚¢ã‚¹ï¼ˆåã‚Šï¼‰
   - ãƒã‚¤ã‚¢ã‚¹ã¨ã¯ï¼šæ¨™æœ¬ãŒæ¯é›†å›£ã‚’æ­£ã—ãä»£è¡¨ã—ã¦ã„ãªã„çŠ¶æ…‹
   
   - ã‚ˆãã‚ã‚‹ãƒã‚¤ã‚¢ã‚¹ã®ä¾‹
     ãƒ»è¡—é ­èª¿æŸ»ï¼šé€šè¡Œäººã ã‘ãŒå¯¾è±¡ï¼ˆå®¶ã«ã„ã‚‹äººã¯å«ã¾ã‚Œãªã„ï¼‰
     ãƒ»é›»è©±èª¿æŸ»ï¼šé›»è©±ã«å‡ºã‚„ã™ã„äººã«åã‚‹
     ãƒ»ãƒãƒƒãƒˆèª¿æŸ»ï¼šãƒãƒƒãƒˆåˆ©ç”¨è€…ã«åã‚‹
     ãƒ»ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ãƒã‚¤ã‚¢ã‚¹ï¼šè‡ªç™ºçš„ã«å‚åŠ ã™ã‚‹äººã¯ç‰¹å®šã®æ„è¦‹ã‚’æŒã¡ã‚„ã™ã„
   
   - ãƒã‚¤ã‚¢ã‚¹ã®å½±éŸ¿ï¼šé–“é•ã£ãŸçµè«–ã‚’å°ãå¯èƒ½æ€§

4. å…¨æ•°èª¿æŸ»ã¨æ¨™æœ¬èª¿æŸ»ã®é•ã„
   - å…¨æ•°èª¿æŸ»ï¼ˆæ‚‰çš†èª¿æŸ»ï¼‰
     ãƒ»æ¯é›†å›£å…¨ä½“ã‚’èª¿æŸ»
     ãƒ»ä¾‹ï¼šå›½å‹¢èª¿æŸ»ã€å­¦æ ¡ã®å®šæœŸè©¦é¨“
     ãƒ»åˆ©ç‚¹ï¼šæ­£ç¢º
     ãƒ»æ¬ ç‚¹ï¼šæ™‚é–“ã¨è²»ç”¨ãŒã‹ã‹ã‚‹ã€ç ´å£Šæ¤œæŸ»ã§ã¯ä¸å¯èƒ½
   
   - æ¨™æœ¬èª¿æŸ»
     ãƒ»ä¸€éƒ¨ã ã‘ã‚’èª¿æŸ»
     ãƒ»ä¾‹ï¼šè¦–è´ç‡èª¿æŸ»ã€ä¸–è«–èª¿æŸ»
     ãƒ»åˆ©ç‚¹ï¼šè¿…é€Ÿã€çµŒæ¸ˆçš„
     ãƒ»æ¬ ç‚¹ï¼šæ¨æ¸¬èª¤å·®ãŒã‚ã‚‹
   
   - é©åˆ‡ãªæ¨™æœ¬ã‚µã‚¤ã‚º
     ãƒ»å¤§ãã™ãã‚‹ã¨ï¼šè²»ç”¨ã¨æ™‚é–“ãŒã‹ã‹ã‚‹
     ãƒ»å°ã•ã™ãã‚‹ã¨ï¼šæ¨æ¸¬ã®ç²¾åº¦ãŒä½ã„
     ãƒ»ãƒãƒ©ãƒ³ã‚¹ãŒé‡è¦

ã€å•é¡Œã®å…·ä½“ä¾‹ã€‘
ä¾‹1ï¼šã€Œå­¦æ ¡å…¨ä½“ã®çµ¦é£Ÿã®äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’èª¿ã¹ãŸã„ã€‚ã©ã®ã‚ˆã†ãªæ–¹æ³•ã§æ¨™æœ¬ã‚’é¸ã¶ã®ãŒé©åˆ‡ã‹ã€
â†’ ç„¡ä½œç‚ºæŠ½å‡ºã®æ–¹æ³•

ä¾‹2ï¼šã€Œã‚ã‚‹å•†å“ã®æº€è¶³åº¦èª¿æŸ»ã‚’è³¼å…¥è€…å…¨å“¡ã«ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’é€ã£ãŸã¨ã“ã‚ã€å›ç­”ç‡ãŒ20%ã ã£ãŸã€‚ã“ã®çµæœã¯ä¿¡é ¼ã§ãã‚‹ã‹ã€
â†’ éå›ç­”ãƒã‚¤ã‚¢ã‚¹ã®ç†è§£

ä¾‹3ï¼šã€Œæ± ã«é­šãŒä½•åŒ¹ã„ã‚‹ã‹èª¿ã¹ãŸã„ã€‚100åŒ¹æ•ã¾ãˆã¦å°ã‚’ã¤ã‘ã¦æˆ»ã—ã€å†ã³100åŒ¹æ•ã¾ãˆãŸã‚‰å°ã®ã¤ã„ãŸé­šãŒ10åŒ¹ã„ãŸã€‚æ± ã«ã¯ç´„ä½•åŒ¹ã®é­šãŒã„ã‚‹ã¨æ¨å®šã§ãã‚‹ã‹ã€
â†’ æ¨™æœ¬èª¿æŸ»ã®å¿œç”¨ï¼ˆæ¨™è­˜å†æ•æ³•ï¼‰`,
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³10: æ¨æ¸¬çµ±è¨ˆã®å…¥å£': {
    grade3: `
ã€å‡ºé¡Œã®èƒŒæ™¯ã¨ç›®çš„ã€‘
è¨˜è¿°çµ±è¨ˆï¼ˆãƒ‡ãƒ¼ã‚¿ã®è¦ç´„ï¼‰ã‹ã‚‰æ¨æ¸¬çµ±è¨ˆï¼ˆæ¯é›†å›£ã®æ¨æ¸¬ï¼‰ã¸ã€‚æ¨™æœ¬ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¯é›†å›£ã«ã¤ã„ã¦ç§‘å­¦çš„ã«æ¨è«–ã™ã‚‹æ–¹æ³•ã‚’ç†è§£ã—ã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚çµ±è¨ˆå­¦ã®æœ€ã‚‚é‡è¦ãªæ¦‚å¿µãŒé›†ç´„ã•ã‚Œã¦ã„ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚

ã€è©³ç´°ãªå‡ºé¡Œå†…å®¹ã€‘
1. æ¨™æœ¬åˆ†å¸ƒã®æ¦‚å¿µ
   - æ¨™æœ¬å¹³å‡ã®åˆ†å¸ƒï¼šåŒã˜æ¯é›†å›£ã‹ã‚‰ä½•åº¦ã‚‚æ¨™æœ¬ã‚’å–ã£ãŸã¨ãã€æ¨™æœ¬å¹³å‡ã¯ã©ã†åˆ†å¸ƒã™ã‚‹ã‹
   - æ¨™æœ¬å¹³å‡ã®æœŸå¾…å€¤ = æ¯å¹³å‡ï¼ˆä¸åæ€§ï¼‰
   - æ¨™æœ¬å¹³å‡ã®æ¨™æº–åå·®ï¼ˆæ¨™æº–èª¤å·®ï¼‰= æ¯æ¨™æº–åå·® / âˆšn
   - å…·ä½“ä¾‹ï¼šã‚µã‚¤ã‚³ãƒ­ã‚’10å›æŒ¯ã£ãŸå¹³å‡ã¯3.5ä»˜è¿‘ã«é›†ã¾ã‚‹ãŒã€ã°ã‚‰ã¤ããŒã‚ã‚‹

2. ä¸­å¿ƒæ¥µé™å®šç†
   - å†…å®¹ï¼šæ¨™æœ¬ã‚µã‚¤ã‚ºnãŒå¤§ãããªã‚‹ã¨ã€æ¯é›†å›£ã®åˆ†å¸ƒã«é–¢ã‚ã‚‰ãšã€æ¨™æœ¬å¹³å‡ã®åˆ†å¸ƒã¯æ­£è¦åˆ†å¸ƒã«è¿‘ã¥ã
   - é‡è¦æ€§ï¼šæ¯é›†å›£ãŒæ­£è¦åˆ†å¸ƒã§ãªãã¦ã‚‚ã€æ¨™æœ¬å¹³å‡ã«ã¤ã„ã¦ã¯æ­£è¦åˆ†å¸ƒã‚’ä»®å®šã§ãã‚‹
   - å®Ÿç”¨ä¸Šã®ç›®å®‰ï¼šn â‰¥ 30 ã§è¿‘ä¼¼çš„ã«æ­£è¦åˆ†å¸ƒ
   - å…·ä½“ä¾‹ï¼šã‚µã‚¤ã‚³ãƒ­ã®ç›®ï¼ˆä¸€æ§˜åˆ†å¸ƒï¼‰ã§ã‚‚ã€å¤šæ•°å›ã®å¹³å‡ã¯æ­£è¦åˆ†å¸ƒã«å¾“ã†
   - å¿œç”¨ï¼šä¸–è«–èª¿æŸ»ã€å“è³ªç®¡ç†ãªã©

3. ä¿¡é ¼åŒºé–“ã®æ¦‚å¿µã¨è§£é‡ˆ
   - ç‚¹æ¨å®šï¼šæ¨™æœ¬å¹³å‡ã‚’æ¯å¹³å‡ã®æ¨å®šå€¤ã¨ã™ã‚‹ï¼ˆ1ã¤ã®å€¤ï¼‰
   - åŒºé–“æ¨å®šï¼šæ¯å¹³å‡ãŒå«ã¾ã‚Œã‚‹ç¯„å›²ã‚’ç¢ºç‡çš„ã«ç¤ºã™ï¼ˆç¯„å›²ï¼‰
   
   - 95%ä¿¡é ¼åŒºé–“ã®æ„å‘³
     ãƒ»ã€Œæ¯å¹³å‡ãŒã“ã®åŒºé–“ã«95%ã®ç¢ºç‡ã§å«ã¾ã‚Œã‚‹ã€ã§ã¯ãªã„ï¼ˆÃ— ã‚ˆãã‚ã‚‹èª¤è§£ï¼‰
     ãƒ»ã€ŒåŒã˜æ–¹æ³•ã§100å›æ¨™æœ¬ã‚’å–ã‚Œã°ã€ç´„95å›ã¯ã“ã®åŒºé–“ã«æ¯å¹³å‡ãŒå«ã¾ã‚Œã‚‹ã€ï¼ˆâ—‹ æ­£ã—ã„è§£é‡ˆï¼‰
   
   - è¨ˆç®—æ–¹æ³•ï¼šæ¨™æœ¬å¹³å‡ Â± 1.96 Ã— æ¨™æº–èª¤å·®ï¼ˆ95%ä¿¡é ¼åŒºé–“ã®å ´åˆï¼‰
   - åŒºé–“ã®å¹…ã®æ„å‘³ï¼šç‹­ã„ã»ã©æ¨å®šã®ç²¾åº¦ãŒé«˜ã„
   - æ¨™æœ¬ã‚µã‚¤ã‚ºã®å½±éŸ¿ï¼šnãŒå¤§ãã„ã»ã©åŒºé–“ã¯ç‹­ããªã‚‹
   
   - å…·ä½“ä¾‹ï¼šä¸–è«–èª¿æŸ»ã§ã€Œæ”¯æŒç‡52%ã€èª¤å·®Â±3%ã€
     â†’ çœŸã®æ”¯æŒç‡ã¯49%ã€œ55%ã®ç¯„å›²ã«ã‚ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã‚‹

4. ä»®èª¬æ¤œå®šã®åŸºç¤
   - åŸºæœ¬çš„ãªæµã‚Œ
     â‘ ä»®èª¬ã‚’ç«‹ã¦ã‚‹ï¼šå¸°ç„¡ä»®èª¬Hâ‚€ã¨å¯¾ç«‹ä»®èª¬Hâ‚
     â‘¡æœ‰æ„æ°´æº–Î±ã‚’è¨­å®šï¼ˆé€šå¸¸5%ã‚„1%ï¼‰
     â‘¢ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã€æ¤œå®šçµ±è¨ˆé‡ã‚’è¨ˆç®—
     â‘£på€¤ã‚’æ±‚ã‚ã‚‹
     â‘¤på€¤<Î±ãªã‚‰å¸°ç„¡ä»®èª¬ã‚’æ£„å´
   
   - å¸°ç„¡ä»®èª¬ï¼ˆHâ‚€ï¼‰ï¼šã€ŒåŠ¹æœãŒãªã„ã€ã€Œå·®ãŒãªã„ã€ã¨ã„ã†ä»®èª¬
     ä¾‹ï¼šã€Œæ–°è–¬ã¯æ—¢å­˜è–¬ã¨åŠ¹æœãŒåŒã˜ã€
   
   - å¯¾ç«‹ä»®èª¬ï¼ˆHâ‚ï¼‰ï¼šã€ŒåŠ¹æœãŒã‚ã‚‹ã€ã€Œå·®ãŒã‚ã‚‹ã€ã¨ã„ã†ä»®èª¬
     ä¾‹ï¼šã€Œæ–°è–¬ã¯æ—¢å­˜è–¬ã‚ˆã‚ŠåŠ¹æœãŒã‚ã‚‹ã€
   
   - på€¤ï¼šå¸°ç„¡ä»®èª¬ãŒæ­£ã—ã„ã¨ä»®å®šã—ãŸã¨ãã€è¦³æ¸¬ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ˆã¾ãŸã¯ãã‚Œä»¥ä¸Šæ¥µç«¯ãªãƒ‡ãƒ¼ã‚¿ï¼‰ãŒå¾—ã‚‰ã‚Œã‚‹ç¢ºç‡
     ãƒ»på€¤ãŒå°ã•ã„ï¼ˆä¾‹ï¼š< 0.05ï¼‰â†’ å¸°ç„¡ä»®èª¬ã¯ç–‘ã‚ã—ã„ â†’ æ£„å´
     ãƒ»på€¤ãŒå¤§ãã„ â†’ å¸°ç„¡ä»®èª¬ã‚’æ£„å´ã§ããªã„
   
   - æœ‰æ„æ°´æº–ï¼ˆÎ±ï¼‰ï¼šã€Œå¸°ç„¡ä»®èª¬ãŒæ­£ã—ã„ã®ã«æ£„å´ã—ã¦ã—ã¾ã†ã€èª¤ã‚Šã‚’è¨±å®¹ã™ã‚‹ç¢ºç‡
     é€šå¸¸5%ï¼ˆ0.05ï¼‰ã¾ãŸã¯1%ï¼ˆ0.01ï¼‰
   
   - ç¬¬ä¸€ç¨®ã®éèª¤ï¼ˆÎ±ï¼‰ï¼šå¸°ç„¡ä»®èª¬ãŒæ­£ã—ã„ã®ã«æ£„å´ã™ã‚‹ï¼ˆã€Œãªã„ã‚‚ã®ã‚’ã‚ã‚‹ã€ã¨è¨€ã†ï¼‰
   - ç¬¬äºŒç¨®ã®éèª¤ï¼ˆÎ²ï¼‰ï¼šå¸°ç„¡ä»®èª¬ãŒèª¤ã‚Šãªã®ã«æ£„å´ã—ãªã„ï¼ˆã€Œã‚ã‚‹ã‚‚ã®ã‚’ãªã„ã€ã¨è¨€ã†ï¼‰
   
   - å…·ä½“ä¾‹ï¼šã€Œã“ã®è–¬ã¯åŠ¹æœãŒã‚ã‚‹ã€ã‚’æ¤œè¨¼
     Hâ‚€ï¼šè–¬ã¯åŠ¹æœãŒãªã„
     Hâ‚ï¼šè–¬ã¯åŠ¹æœãŒã‚ã‚‹
     å®Ÿé¨“â†’på€¤=0.02â†’p<0.05â†’Hâ‚€ã‚’æ£„å´â†’è–¬ã¯åŠ¹æœãŒã‚ã‚‹ã¨çµè«–

ã€å•é¡Œã®å…·ä½“ä¾‹ã€‘
ä¾‹1ï¼šã€Œæ¨™æœ¬ã‚µã‚¤ã‚ºã‚’4å€ã«ã™ã‚‹ã¨ã€æ¨™æœ¬å¹³å‡ã®æ¨™æº–èª¤å·®ã¯ã©ã†ãªã‚‹ã‹ã€
â†’ æ¨™æº–èª¤å·®ã®æ€§è³ª

ä¾‹2ï¼šã€Œ95%ä¿¡é ¼åŒºé–“ãŒ[48, 52]ã§ã‚ã‚‹ã¨ãã€ã“ã®è§£é‡ˆã¨ã—ã¦é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã‹ã€
â†’ ä¿¡é ¼åŒºé–“ã®æ­£ã—ã„è§£é‡ˆ

ä¾‹3ï¼šã€Œæ–°ã—ã„æ•™è‚²æ–¹æ³•ã®åŠ¹æœã‚’æ¤œè¨¼ã™ã‚‹å®Ÿé¨“ã§ã€på€¤=0.08ãŒå¾—ã‚‰ã‚ŒãŸï¼ˆæœ‰æ„æ°´æº–5%ï¼‰ã€‚ã“ã®çµæœã‚’ã©ã†è§£é‡ˆã™ã‚‹ã‹ã€
â†’ ä»®èª¬æ¤œå®šã®åˆ¤æ–­ã¨è§£é‡ˆ`,
  },
  'ã‚»ã‚¯ã‚·ãƒ§ãƒ³10: ãƒ‡ãƒ¼ã‚¿åé›†ã¨èª¿æŸ»è¨ˆç”»': {
    grade4: `
ã€å‡ºé¡Œã®èƒŒæ™¯ã¨ç›®çš„ã€‘
ãƒ‡ãƒ¼ã‚¿åˆ†æã®å‰æ®µéšã¨ã—ã¦ã€é©åˆ‡ã«ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€èª¿æŸ»ã®è¨­è¨ˆã‹ã‚‰å®Ÿæ–½ã€ãƒ‡ãƒ¼ã‚¿æ•´ç†ã¾ã§ã®åŸºæœ¬çš„ãªæµã‚Œã‚’ç†è§£ã—ã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

ã€è©³ç´°ãªå‡ºé¡Œå†…å®¹ã€‘
1. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è¨­è¨ˆæ–¹æ³•
   - ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ç›®çš„ã‚’æ˜ç¢ºã«ã™ã‚‹
     ãƒ»ä½•ã‚’çŸ¥ã‚ŠãŸã„ã®ã‹
     ãƒ»èª°ã«èãã®ã‹
     ãƒ»ã©ã†æ´»ç”¨ã™ã‚‹ã®ã‹
   
   - è‰¯ã„è³ªå•ã®æ¡ä»¶
     â—‹ æ˜ç¢ºã§åˆ†ã‹ã‚Šã‚„ã™ã„ï¼ˆå°‚é–€ç”¨èªã‚’é¿ã‘ã‚‹ï¼‰
     â—‹ ä¸€ã¤ã®è³ªå•ã§ä¸€ã¤ã®ã“ã¨ã‚’èã
     â—‹ èª˜å°çš„ã§ãªã„ï¼ˆç‰¹å®šã®ç­”ãˆã«èª˜å°ã—ãªã„ï¼‰
     â—‹ ç­”ãˆã‚„ã™ã„ï¼ˆé¸æŠè‚¢ã‚’ç”¨æ„ã™ã‚‹ï¼‰
   
   - æ‚ªã„è³ªå•ã®ä¾‹
     Ã— ã€Œã‚ãªãŸã¯å¥åº·çš„ã§ç¾å‘³ã—ã„é‡èœãŒå¥½ãã§ã™ã‹ï¼Ÿã€ï¼ˆ2ã¤ã®è³ªå•ï¼‰
     Ã— ã€Œç’°å¢ƒã«å„ªã—ã„ã‚¨ã‚³å•†å“ã‚’ä½¿ã†ã¹ãã ã¨æ€ã„ã¾ã›ã‚“ã‹ï¼Ÿã€ï¼ˆèª˜å°çš„ï¼‰
     Ã— ã€Œæ˜¨å¹´ä½•å›æ˜ ç”»é¤¨ã«è¡Œãã¾ã—ãŸã‹ï¼Ÿã€ï¼ˆè¦šãˆã¦ã„ãªã„ï¼‰
   
   - è‰¯ã„è³ªå•ã®ä¾‹
     â—‹ ã€Œé‡èœã¯å¥½ãã§ã™ã‹ï¼Ÿã€ï¼ˆã¯ã„/ã„ã„ãˆï¼‰
     â—‹ ã€Œæ˜ ç”»é¤¨ã«ã¯æœˆã«ä½•å›ç¨‹åº¦è¡Œãã¾ã™ã‹ï¼Ÿã€ï¼ˆ0å›/1å›/2ã€œ3å›/4å›ä»¥ä¸Šï¼‰

2. è³ªå•é …ç›®ã®é¸å®š
   - å¿…è¦ãªæƒ…å ±ã‚’æ¼ã‚Œãªãé›†ã‚ã‚‹
   - ä¸è¦ãªè³ªå•ã¯çœãï¼ˆå›ç­”è€…ã®è² æ‹…ã‚’æ¸›ã‚‰ã™ï¼‰
   - å€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„ã«æ³¨æ„
   - è³ªå•ã®é †åºã‚’å·¥å¤«ï¼ˆç°¡å˜ãªè³ªå•ã‹ã‚‰å§‹ã‚ã‚‹ï¼‰

3. èª¿æŸ»ã®è¨ˆç”»ã¨å®Ÿæ–½
   - èª¿æŸ»æ–¹æ³•ã®é¸æŠ
     ãƒ»è³ªå•ç´™èª¿æŸ»ï¼šå¤šæ•°ã®äººã«é…å¸ƒã§ãã‚‹
     ãƒ»é¢æ¥èª¿æŸ»ï¼šè©³ã—ã„æƒ…å ±ãŒå¾—ã‚‰ã‚Œã‚‹
     ãƒ»è¦³å¯Ÿèª¿æŸ»ï¼šå®Ÿéš›ã®è¡Œå‹•ã‚’è¨˜éŒ²
     ãƒ»å®Ÿé¨“ï¼šæ¡ä»¶ã‚’å¤‰ãˆã¦æ¯”è¼ƒ
   
   - èª¿æŸ»ã®å®Ÿæ–½æ‰‹é †
     â‘ ç›®çš„ã®æ˜ç¢ºåŒ–
     â‘¡èª¿æŸ»æ–¹æ³•ã®é¸æŠ
     â‘¢è³ªå•é …ç›®ã®ä½œæˆ
     â‘£äºˆå‚™èª¿æŸ»ï¼ˆãƒ†ã‚¹ãƒˆï¼‰
     â‘¤æœ¬èª¿æŸ»ã®å®Ÿæ–½
     â‘¥ãƒ‡ãƒ¼ã‚¿ã®æ•´ç†ã¨åˆ†æ
   
   - æ³¨æ„ç‚¹
     ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã®ä¿è­·
     ãƒ»å›ç­”ã®ä»»æ„æ€§ï¼ˆå¼·åˆ¶ã—ãªã„ï¼‰
     ãƒ»ãƒ‡ãƒ¼ã‚¿ã®é©åˆ‡ãªç®¡ç†

4. ãƒ‡ãƒ¼ã‚¿ã®æ•´ç†æ–¹æ³•
   - æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã®æ•´ç†
     ãƒ»åº¦æ•°åˆ†å¸ƒè¡¨ã‚’ä½œã‚‹
     ãƒ»ã‚°ãƒ©ãƒ•ã§å¯è¦–åŒ–ã™ã‚‹
     ãƒ»ä»£è¡¨å€¤ã‚’è¨ˆç®—ã™ã‚‹
   
   - ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æ•´ç†
     ãƒ»åˆ†é¡ã—ã¦é›†è¨ˆã™ã‚‹
     ãƒ»å‰²åˆã‚’è¨ˆç®—ã™ã‚‹
     ãƒ»å††ã‚°ãƒ©ãƒ•ã‚„æ£’ã‚°ãƒ©ãƒ•ã§è¡¨ã™
   
   - ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯
     ãƒ»ç•°å¸¸å€¤ï¼ˆãŠã‹ã—ãªå€¤ï¼‰ãŒãªã„ã‹
     ãƒ»æœªè¨˜å…¥ãŒãªã„ã‹
     ãƒ»çŸ›ç›¾ãŒãªã„ã‹

5. è¦³å¯Ÿç ”ç©¶ã¨å®Ÿé¨“ç ”ç©¶ã®é•ã„
   - è¦³å¯Ÿç ”ç©¶ï¼šè‡ªç„¶ãªçŠ¶æ…‹ã‚’è¦³å¯Ÿ
     ä¾‹ï¼šå–«ç…™è€…ã¨éå–«ç…™è€…ã®å¥åº·çŠ¶æ…‹ã‚’æ¯”è¼ƒ
     åˆ©ç‚¹ï¼šå€«ç†çš„å•é¡ŒãŒå°‘ãªã„ã€å®Ÿéš›ã®çŠ¶æ³ã‚’åæ˜ 
     æ¬ ç‚¹ï¼šå› æœé–¢ä¿‚ã®è¨¼æ˜ãŒé›£ã—ã„
   
   - å®Ÿé¨“ç ”ç©¶ï¼šæ¡ä»¶ã‚’æ“ä½œã—ã¦æ¯”è¼ƒ
     ä¾‹ï¼šè–¬ã‚’æŠ•ä¸ã™ã‚‹ç¾¤ã¨ã—ãªã„ç¾¤ã‚’æ¯”è¼ƒ
     åˆ©ç‚¹ï¼šå› æœé–¢ä¿‚ã‚’æ˜ç¢ºã«ã§ãã‚‹
     æ¬ ç‚¹ï¼šå€«ç†çš„é…æ…®ãŒå¿…è¦ã€è²»ç”¨ãŒã‹ã‹ã‚‹

ã€å•é¡Œã®å…·ä½“ä¾‹ã€‘
ä¾‹1ï¼šã€Œæ¬¡ã®è³ªå•ã®ä¸­ã§ã€ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¨ã—ã¦é©åˆ‡ã§ãªã„ã‚‚ã®ã¯ã©ã‚Œã‹ã€
(1)å¥½ããªè‰²ã¯ä½•ã§ã™ã‹ï¼Ÿ
(2)å¥åº·çš„ã§ç¾å‘³ã—ã„é£Ÿäº‹ã¯é‡è¦ã ã¨æ€ã„ã¾ã›ã‚“ã‹ï¼Ÿ
(3)1æ—¥ã«ä½•æ™‚é–“ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ã¾ã™ã‹ï¼Ÿ
(4)æœé£Ÿã‚’æ¯æ—¥é£Ÿã¹ã¾ã™ã‹ï¼Ÿ
â†’ èª˜å°çš„ãªè³ªå•ã®è­˜åˆ¥

ä¾‹2ï¼šã€Œã‚¯ãƒ©ã‚¹ã§å¥½ããªçµ¦é£Ÿãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’èª¿æŸ»ã—ãŸã„ã€‚ã©ã®ã‚ˆã†ãªæ–¹æ³•ãŒé©åˆ‡ã‹ã€
â†’ èª¿æŸ»æ–¹æ³•ã®é¸æŠ

ä¾‹3ï¼šã€Œé‹å‹•ã¨æˆç¸¾ã®é–¢ä¿‚ã‚’èª¿ã¹ã‚‹ã¨ãã€è¦³å¯Ÿç ”ç©¶ã¨å®Ÿé¨“ç ”ç©¶ã§ã¯ã©ã¡ã‚‰ãŒé©åˆ‡ã‹ã€‚ç†ç”±ã‚‚å«ã‚ã¦ç­”ãˆã‚ˆã€
â†’ ç ”ç©¶æ–¹æ³•ã®é¸æŠã¨ç†ç”±`
  }
};

export async function generateQuestions(
  request: QuestionGenerationRequest
): Promise<GeneratedQuestion[]> {
  const model = genAI.getGenerativeModel({ 
    model: 'gemini-2.5-flash',
    generationConfig: {
      temperature: 0.7,
      topP: 0.95,
      topK: 40,
      maxOutputTokens: 8192,
      responseMimeType: 'application/json',  // ğŸ”¥ JSON mode ã‚’æœ‰åŠ¹åŒ–
    }
  });

  const grade4Topics = `
ã€4ç´šã®å‡ºé¡Œç¯„å›²ã€‘
- ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ï¼ˆé‡çš„ãƒ‡ãƒ¼ã‚¿ã€è³ªçš„ãƒ‡ãƒ¼ã‚¿ï¼‰
- åº¦æ•°åˆ†å¸ƒè¡¨ï¼ˆç›¸å¯¾åº¦æ•°ã€ç´¯ç©åº¦æ•°ã€éšç´šå€¤ï¼‰
- ã‚°ãƒ©ãƒ•ã®èª­ã¿å–ã‚Šï¼ˆãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã€ç®±ã²ã’å›³ã€å††ã‚°ãƒ©ãƒ•ã€å¸¯ã‚°ãƒ©ãƒ•ã€æ•£å¸ƒå›³ã€å¹¹è‘‰å›³ã€ãƒ‰ãƒƒãƒˆãƒ—ãƒ­ãƒƒãƒˆï¼‰
- ä»£è¡¨å€¤ï¼ˆå¹³å‡å€¤ã€ä¸­å¤®å€¤ã€æœ€é »å€¤ï¼‰
- æ•£ã‚‰ã°ã‚Šã®æŒ‡æ¨™ï¼ˆç¯„å›²ã€å››åˆ†ä½ç¯„å›²ã€åˆ†æ•£ã€æ¨™æº–åå·®ï¼‰
- åå·®å€¤ã®è¨ˆç®—
- ç¢ºç‡ã®åŸºæœ¬ï¼ˆç‹¬ç«‹äº‹è±¡ã€æ¡ä»¶ä»˜ãç¢ºç‡ï¼‰
- å‰²åˆãƒ»æ¯”ç‡ã®è¨ˆç®—
- ã‚¯ãƒ­ã‚¹é›†è¨ˆè¡¨ã®èª­ã¿å–ã‚Š
- æ¨™æœ¬èª¿æŸ»ï¼ˆæ¯é›†å›£ã€æ¨™æœ¬ã€ç„¡ä½œç‚ºæŠ½å‡ºï¼‰
- å®Ÿé¨“è¨ˆç”»ã®åŸºç¤ï¼ˆå¯¾ç…§ç¾¤ã€å®Ÿé¨“ç¾¤ï¼‰
- æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Š`;

  const grade3Topics = `
ã€3ç´šã®å‡ºé¡Œç¯„å›²ã€‘
- æ¨™æº–åå·®ã€åˆ†æ•£ã€å¤‰å‹•ä¿‚æ•°
- ç›¸é–¢ä¿‚æ•°ã€å…±åˆ†æ•£ã€æ•£å¸ƒå›³
- å›å¸°åˆ†æï¼ˆå›å¸°å¼ã€æ±ºå®šä¿‚æ•°ã€æ®‹å·®ï¼‰
- ç¢ºç‡åˆ†å¸ƒï¼ˆäºŒé …åˆ†å¸ƒã€æ­£è¦åˆ†å¸ƒã®åŸºæœ¬ï¼‰
- æ¨™æœ¬åˆ†å¸ƒã€ä¸­å¿ƒæ¥µé™å®šç†
- ä¿¡é ¼åŒºé–“ã®æ¦‚å¿µã¨è¨ˆç®—
- ä»®èª¬æ¤œå®šï¼ˆå¸°ç„¡ä»®èª¬ã€å¯¾ç«‹ä»®èª¬ã€på€¤ã€æœ‰æ„æ°´æº–ï¼‰
- tæ¤œå®šã€Fæ¤œå®šã€ã‚«ã‚¤äºŒä¹—æ¤œå®šã®åŸºæœ¬
- ç¬¬ä¸€ç¨®ãƒ»ç¬¬äºŒç¨®ã®éèª¤
- å®Ÿé¨“è¨ˆç”»ï¼ˆç„¡ä½œç‚ºåŒ–ã€ãƒ–ãƒ­ãƒƒã‚¯åŒ–ï¼‰
- æ¨™æœ¬èª¿æŸ»ï¼ˆå±¤åˆ¥æŠ½å‡ºã€ç³»çµ±æŠ½å‡ºï¼‰
- å¤šé‡æ¯”è¼ƒã®æ¦‚å¿µ
- ãƒãƒ³ãƒ‘ãƒ©ãƒ¡ãƒˆãƒªãƒƒã‚¯æ¤œå®šã®åŸºæœ¬`;

  let prompt = '';

  if (request.type === 'section') {
    const sectionKey = request.section || '';
    const gradeKey = request.grade === '3ç´š' ? 'grade3' : 'grade4';
    const detailedPrompt = sectionPrompts[sectionKey]?.[gradeKey] || request.sectionDescription;

    prompt = `# å½¹å‰²å®šç¾©
ã‚ãªãŸã¯æ—¥æœ¬çµ±è¨ˆå­¦ä¼šãŒä¸»å‚¬ã™ã‚‹ã€Œçµ±è¨ˆæ¤œå®šã€ã®å•é¡Œä½œæˆã‚’20å¹´ä»¥ä¸Šæ‹…å½“ã—ã¦ã„ã‚‹å°‚é–€å®¶ã§ã™ã€‚
çµ±è¨ˆå­¦ã®æ·±ã„çŸ¥è­˜ã¨ã€å­¦ç¿’è€…ã®ç†è§£åº¦ã«åˆã‚ã›ãŸé©åˆ‡ãªå•é¡Œè¨­è¨ˆã®çµŒé¨“ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
ä»Šå›ã€${request.grade}ãƒ¬ãƒ™ãƒ«ã®å­¦ç¿’è€…å‘ã‘ã«ã€æ•™è‚²åŠ¹æœã®é«˜ã„ç·´ç¿’å•é¡Œã‚’ä½œæˆã™ã‚‹ä»»å‹™ã‚’æ‹…ã£ã¦ã„ã¾ã™ã€‚

# ã‚ãªãŸã®è²¬å‹™
- å­¦ç¿’è€…ãŒçµ±è¨ˆçš„æ€è€ƒåŠ›ã‚’èº«ã«ã¤ã‘ã‚‰ã‚Œã‚‹è‰¯è³ªãªå•é¡Œã‚’ä½œæˆã™ã‚‹ã“ã¨
- å®Ÿéš›ã®çµ±è¨ˆæ¤œå®šã®å‡ºé¡Œå‚¾å‘ã¨é›£æ˜“åº¦ã‚’æ­£ç¢ºã«åæ˜ ã™ã‚‹ã“ã¨
- èª¤ç­”é¸æŠè‚¢ã‹ã‚‰ã‚‚å­¦ã¹ã‚‹ã€æ•™è‚²çš„é…æ…®ã®ã‚ã‚‹å•é¡Œè¨­è¨ˆã‚’ã™ã‚‹ã“ã¨
- å®Ÿå‹™ã§å½¹ç«‹ã¤å®Ÿè·µçš„ãªå•é¡Œè¨­å®šã‚’å¿ƒãŒã‘ã‚‹ã“ã¨

# ä½œæˆã™ã‚‹å•é¡Œã®æ¡ä»¶
- å¯¾è±¡ç´š: ${request.grade}
- å‡ºé¡Œç¯„å›²: ${request.section}
- å•é¡Œæ•°: ${request.count}å•

# å‡ºé¡Œå†…å®¹ã®è©³ç´°æŒ‡å®š
${detailedPrompt}

# è‰¯ã„å•é¡Œã®ä¾‹ï¼ˆå‚è€ƒã«ã™ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
ã€ä¾‹1ï¼šè¨ˆç®—å•é¡Œï¼ˆé©åˆ‡ï¼‰ã€‘
å•é¡Œæ–‡: ã€Œã‚ã‚‹ã‚¯ãƒ©ã‚¹5äººã®ãƒ†ã‚¹ãƒˆã®ç‚¹æ•°ã¯ {60, 70, 80, 85, 85} ã§ã‚ã‚‹ã€‚ã“ã®å¹³å‡å€¤ã¨ä¸­å¤®å€¤ã‚’æ±‚ã‚ã‚ˆã€‚ã€
é¸æŠè‚¢:
1. å¹³å‡å€¤76ã€ä¸­å¤®å€¤80
2. å¹³å‡å€¤80ã€ä¸­å¤®å€¤80 âœ“ï¼ˆæ­£è§£ï¼‰
3. å¹³å‡å€¤80ã€ä¸­å¤®å€¤85
4. å¹³å‡å€¤76ã€ä¸­å¤®å€¤85
è§£èª¬: ã€Œå¹³å‡å€¤ = (60+70+80+85+85)/5 = 380/5 = 76... ã§ã¯ãªãã€æ­£ã—ãã¯ (60+70+80+85+85)/5 = 380/5 = 76ã€‚ã‚ã‚Œã€è¨ˆç®—ã‚’ç¢ºèªã™ã‚‹ã¨... æ­£ã—ãã¯380/5 = 76ã§ã™ã€‚ä¸­å¤®å€¤ã¯ä¸¦ã¹ã¦çœŸã‚“ä¸­ã®å€¤ãªã®ã§80ã§ã™ã€‚ã€

ã€ä¾‹2ï¼šæ¦‚å¿µå•é¡Œï¼ˆé©åˆ‡ï¼‰ã€‘
å•é¡Œæ–‡: ã€Œç›¸é–¢ä¿‚æ•°ãŒ r = -0.8 ã§ã‚ã‚‹2ã¤ã®å¤‰æ•°ã®é–¢ä¿‚ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã‹ã€‚ã€
é¸æŠè‚¢:
1. å¼·ã„æ­£ã®ç›¸é–¢ãŒã‚ã‚‹
2. å¼·ã„è² ã®ç›¸é–¢ãŒã‚ã‚‹ âœ“ï¼ˆæ­£è§£ï¼‰
3. å¼±ã„è² ã®ç›¸é–¢ãŒã‚ã‚‹
4. ç›¸é–¢ã¯ãªã„
è§£èª¬: ã€Œç›¸é–¢ä¿‚æ•°ã¯-1ã‹ã‚‰1ã®å€¤ã‚’å–ã‚Šã€çµ¶å¯¾å€¤ãŒ1ã«è¿‘ã„ã»ã©ç›¸é–¢ãŒå¼·ããªã‚Šã¾ã™ã€‚r = -0.8ã¯çµ¶å¯¾å€¤ãŒ0.8ã¨1ã«è¿‘ãã€è² ã®å€¤ãªã®ã§å¼·ã„è² ã®ç›¸é–¢ã‚’ç¤ºã—ã¾ã™ã€‚ä¸€æ–¹ã®å¤‰æ•°ãŒå¢—åŠ ã™ã‚‹ã¨ä»–æ–¹ãŒæ¸›å°‘ã™ã‚‹é–¢ä¿‚ã§ã™ã€‚ã€

# é¿ã‘ã‚‹ã¹ãæ‚ªã„å•é¡Œã®ä¾‹
ã€ä¾‹ï¼šæ›–æ˜§ãªå•é¡Œï¼ˆä¸é©åˆ‡ï¼‰ã€‘
âŒ å•é¡Œæ–‡: ã€Œãƒ‡ãƒ¼ã‚¿ã®ä»£è¡¨å€¤ã«ã¤ã„ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã‹ã€‚ã€
ç†ç”±: ä½•ã‚’å•ã†ã¦ã„ã‚‹ã®ã‹ä¸æ˜ç¢ºã€‚ã€Œæ­£ã—ã„ã€ã®åŸºæº–ãŒæ›–æ˜§ã€‚

ã€ä¾‹ï¼šç¯„å›²å¤–ã®å•é¡Œï¼ˆä¸é©åˆ‡ï¼‰ã€‘  
âŒ å•é¡Œæ–‡ï¼ˆ4ç´šã§ï¼‰: ã€Œãƒ™ã‚¤ã‚ºã®å®šç†ã‚’ç”¨ã„ã¦äº‹å¾Œç¢ºç‡ã‚’è¨ˆç®—ã›ã‚ˆã€‚ã€
ç†ç”±: ãƒ™ã‚¤ã‚ºã®å®šç†ã¯4ç´šã®ç¯„å›²å¤–ã€‚

ã€ä¾‹ï¼šä¸è‡ªç„¶ãªé¸æŠè‚¢ï¼ˆä¸é©åˆ‡ï¼‰ã€‘
âŒ é¸æŠè‚¢: 1. å¹³å‡å€¤ã¯76ã§ã™ 2. å¹³å‡å€¤ã¯77ã§ã™ 3. ãƒãƒŠãƒŠ 4. å¹³å‡å€¤ã¯78ã§ã™
ç†ç”±: é¸æŠè‚¢3ãŒæ˜ã‚‰ã‹ã«ä¸è‡ªç„¶ã§ã€å•é¡Œã®è³ªã‚’æãªã†ã€‚

ã€å•é¡Œä½œæˆã®è¦ä»¶ï¼ˆå¿…é ˆï¼‰ã€‘
1. å‡ºåŠ›å½¢å¼
   - å„å•é¡Œã¯4æŠå½¢å¼ï¼ˆé¸æŠè‚¢ã¯4ã¤ï¼‰
   - æ­£è§£ã¯1ã€œ4ã®æ•´æ•°ã§æŒ‡å®šï¼ˆcorrect ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
   - å•é¡ŒIDã¯1ã‹ã‚‰é †ç•ªã«ä»˜ä¸

2. é›£æ˜“åº¦ã¨ç¯„å›²
   - ${request.grade}ã®é›£æ˜“åº¦ã«å³å¯†ã«åˆã‚ã›ã‚‹
   - æŒ‡å®šã•ã‚ŒãŸå‡ºé¡Œå†…å®¹ã®ç¯„å›²å†…ã§å•é¡Œã‚’ä½œæˆ
   - ç¯„å›²å¤–ã®é«˜åº¦ãªæ¦‚å¿µã‚„ç”¨èªã¯ä½¿ç”¨ã—ãªã„

3. å•é¡Œæ–‡ã®ä½œæˆ
   - æ˜ç¢ºã§æ›–æ˜§ã•ã®ãªã„è¡¨ç¾ã‚’ä½¿ç”¨
   - å…·ä½“çš„ãªã‚·ãƒŠãƒªã‚ªã‚„æ•°å€¤ä¾‹ã‚’å«ã‚ã‚‹
   - å°‚é–€ç”¨èªã¯${request.grade}ãƒ¬ãƒ™ãƒ«ã«é©ã—ãŸã‚‚ã®ã‚’ä½¿ç”¨
   - å•é¡Œæ–‡ã¯ç°¡æ½”ã«ã—ã¤ã¤ã€å¿…è¦ãªæƒ…å ±ã‚’ã™ã¹ã¦å«ã‚ã‚‹

4. é¸æŠè‚¢ã®ä½œæˆï¼ˆé‡è¦ï¼‰
   - æ­£è§£ã®é¸æŠè‚¢ï¼šå®Œå…¨ã«æ­£ã—ãã€ç–‘ã„ã®ä½™åœ°ãŒãªã„
   - èª¤ç­”ã®é¸æŠè‚¢ï¼šã‚‚ã£ã¨ã‚‚ã‚‰ã—ãã€ã‚ˆãã‚ã‚‹èª¤è§£ã‚„è¨ˆç®—ãƒŸã‚¹ã‚’åæ˜ 
   - 4ã¤ã®é¸æŠè‚¢ã¯äº’ã„ã«æ’ä»–çš„ï¼ˆé‡è¤‡ã—ãªã„ï¼‰
   - é¸æŠè‚¢ã®é•·ã•ã‚„å½¢å¼ã‚’ã‚ã‚‹ç¨‹åº¦æƒãˆã‚‹
   - ã€Œã™ã¹ã¦æ­£ã—ã„ã€ã€Œã©ã‚Œã‚‚æ­£ã—ããªã„ã€ã®ã‚ˆã†ãªé¸æŠè‚¢ã¯åŸå‰‡é¿ã‘ã‚‹

5. è§£èª¬ã®ä½œæˆï¼ˆæœ€é‡è¦ï¼‰
   - ãªãœãã®é¸æŠè‚¢ãŒæ­£è§£ãªã®ã‹ã‚’æ˜ç¢ºã«èª¬æ˜
   - èª¤ç­”ã®é¸æŠè‚¢ãŒãªãœé–“é•ã„ãªã®ã‹ã‚‚ç°¡æ½”ã«èª¬æ˜
   - è¨ˆç®—å•é¡Œã®å ´åˆã¯è¨ˆç®—éç¨‹ã‚’æ®µéšçš„ã«ç¤ºã™
   - æ¦‚å¿µå•é¡Œã®å ´åˆã¯æ ¹æ‹ ã¨ãªã‚‹ç†è«–ã‚„å®šç¾©ã‚’ç¤ºã™
   - å®Ÿå‹™ã§ã®å¿œç”¨ä¾‹ã‚„æ³¨æ„ç‚¹ãŒã‚ã‚Œã°è¿½è¨˜
   - è§£èª¬ã¯200ã€œ400æ–‡å­—ç¨‹åº¦ã§ã€ä¸å¯§ã‹ã¤åˆ†ã‹ã‚Šã‚„ã™ã

6. å•é¡Œã®å¤šæ§˜æ€§
   - è¨ˆç®—å•é¡Œï¼šå…·ä½“çš„ãªæ•°å€¤ã‚’ä½¿ã£ãŸè¨ˆç®—ï¼ˆ30ã€œ40%ï¼‰â†’ ã‚°ãƒ©ãƒ•ä½¿ç”¨ç‡70%ä»¥ä¸Š
   - æ¦‚å¿µå•é¡Œï¼šå®šç¾©ã‚„ç‰¹å¾´ã®ç†è§£ã‚’å•ã†ï¼ˆ30ã€œ40%ï¼‰â†’ ã‚°ãƒ©ãƒ•ä½¿ç”¨ç‡50%ä»¥ä¸Š
   - å¿œç”¨å•é¡Œï¼šå®Ÿéš›ã®å ´é¢ã§ã®åˆ¤æ–­ã‚’å•ã†ï¼ˆ20ã€œ30%ï¼‰â†’ ã‚°ãƒ©ãƒ•ä½¿ç”¨ç‡80%ä»¥ä¸Š
   
   ğŸ¯ å…¨ä½“ã§ã‚°ãƒ©ãƒ•ä½¿ç”¨ç‡60-70%ã‚’é”æˆã™ã‚‹ã“ã¨
   - è¨ˆç®—å•é¡Œã§ã‚‚ã‚°ãƒ©ãƒ•ã‹ã‚‰å€¤ã‚’èª­ã¿å–ã‚‹å½¢å¼ã‚’å„ªå…ˆ
   - æ¦‚å¿µå•é¡Œã§ã‚‚ã‚°ãƒ©ãƒ•ä¾‹ã‚’ç¤ºã™ã“ã¨ã§ç†è§£ã‚’æ·±ã‚ã‚‹
   - å¿œç”¨å•é¡Œã¯å®Ÿãƒ‡ãƒ¼ã‚¿ã®ã‚°ãƒ©ãƒ•ã‚’ä½¿ã†ã“ã¨ãŒå¿…é ˆ

ã€ã‚°ãƒ©ãƒ•ä½¿ç”¨ã€‘60-70%ã®å•é¡Œã§ã‚°ãƒ©ãƒ•ã‚’ä½¿ç”¨
- ç›¸é–¢/å›å¸°: 100%ã€ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ : 90%ã€ç®±ã²ã’å›³: 100%ã€æ™‚ç³»åˆ—: 80%
- ã‚°ãƒ©ãƒ•å•é¡Œã§ã¯ã€Œä¸‹ã®ã‚°ãƒ©ãƒ•ã€ã€Œæ¬¡ã®å›³ã€ã‚’ä½¿ç”¨
- ã‚°ãƒ©ãƒ•ä¸è¦: å®šç¾©å•é¡Œã€å…¬å¼å•é¡Œã®ã¿ï¼ˆ30-40%ï¼‰

ã€å•é¡Œä½œæˆã®æˆ¦ç•¥ï¼ˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰ã€‘
1. æ®µéšçš„ãªé›£æ˜“åº¦è¨­å®š
   - æœ€åˆã®2ã€œ3å•ï¼šåŸºæœ¬çš„ãªå®šç¾©ã‚„ç°¡å˜ãªè¨ˆç®—
   - ä¸­é–“ã®4ã€œ6å•ï¼šæ¨™æº–çš„ãªå•é¡Œ
   - æœ€å¾Œã®2ã€œ3å•ï¼šã‚„ã‚„å¿œç”¨çš„ã¾ãŸã¯è¤‡åˆçš„ãªå•é¡Œ

2. èª¤ç­”é¸æŠè‚¢ã®è¨­è¨ˆï¼ˆå­¦ç¿’åŠ¹æœã‚’é«˜ã‚ã‚‹ï¼‰
   - è¨ˆç®—ãƒŸã‚¹ã«ã‚ˆã‚‹èª¤ç­”ï¼ˆç¬¦å·ãƒŸã‚¹ã€æ¡é•ã„ã€è¨ˆç®—é †åºã®èª¤ã‚Šãªã©ï¼‰
   - æ¦‚å¿µã®æ··åŒï¼ˆä¼¼ãŸç”¨èªã‚„æ‰‹æ³•ã®å–ã‚Šé•ãˆï¼‰
   - éƒ¨åˆ†çš„ã«æ­£ã—ã„ãŒå®Œå…¨ã§ã¯ãªã„é¸æŠè‚¢
   - ç›´æ„Ÿçš„ã«ã¯æ­£ã—ãã†ã ãŒè«–ç†çš„ã«èª¤ã£ã¦ã„ã‚‹é¸æŠè‚¢

3. å®Ÿè·µçš„ãªã‚·ãƒŠãƒªã‚ªã®ä½¿ç”¨
   - èº«è¿‘ãªä¾‹ï¼šãƒ†ã‚¹ãƒˆã®ç‚¹æ•°ã€æ°—æ¸©ã€èº«é•·ä½“é‡ã€å£²ä¸Šãªã©
   - å®Ÿéš›ã®çµ±è¨ˆæ¤œå®šã§å‡ºé¡Œã•ã‚Œãã†ãªçŠ¶æ³è¨­å®š
   - å­¦ç¿’è€…ãŒç†è§£ã—ã‚„ã™ã„å…·ä½“çš„ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

4. ç”¨èªã¨è¡¨è¨˜ã®çµ±ä¸€
   - çµ±è¨ˆç”¨èªã¯æ­£å¼ãªæ—¥æœ¬èªè¡¨è¨˜ã‚’ä½¿ç”¨
   - æ•°å¼ã¯åˆ†ã‹ã‚Šã‚„ã™ãè¡¨è¨˜ï¼ˆå¿…è¦ã«å¿œã˜ã¦æ—¥æœ¬èªã§èª¬æ˜ï¼‰
   - ç•¥èªã‚’ä½¿ã†å ´åˆã¯åˆå‡ºæ™‚ã«æ­£å¼åç§°ã‚‚ä½µè¨˜

5. é¿ã‘ã‚‹ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³
   Ã— ãƒˆãƒªãƒƒã‚­ãƒ¼ãªå•é¡Œï¼ˆæšã’è¶³å–ã‚Šï¼‰
   Ã— ç¯„å›²å¤–ã®é«˜åº¦ãªå†…å®¹
   Ã— æ›–æ˜§ãªè¡¨ç¾ã§è¤‡æ•°è§£é‡ˆãŒå¯èƒ½ãªå•é¡Œ
   Ã— å®Ÿå‹™ã§ä½¿ã‚ã‚Œãªã„æ¶ç©ºã®æ¦‚å¿µ
   Ã— é¸æŠè‚¢ãŒæ˜ã‚‰ã‹ã«ä¸è‡ªç„¶ãªã‚‚ã®

ã€å‡ºåŠ›å½¢å¼ã€‘âš ï¸âš ï¸âš ï¸ çµ¶å¯¾å³å®ˆ âš ï¸âš ï¸âš ï¸

ğŸš¨ JSONé…åˆ—ã®ã¿å‡ºåŠ›ï¼ˆèª¬æ˜æ–‡ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ç­‰ã¯ä¸€åˆ‡ç¦æ­¢ï¼‰
ğŸš¨ æ–‡å­—åˆ—å†…ã«æ”¹è¡Œãƒ»ã‚¿ãƒ–ãƒ»åˆ¶å¾¡æ–‡å­—ã‚’å«ã‚ãªã„ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã«ç½®æ›ï¼‰
ğŸš¨ å¿…ãšæœ‰åŠ¹ãªJSONå½¢å¼ï¼ˆtrailing commaãªã—ï¼‰

æ­£ã—ã„ä¾‹:
[{"id":1,"question":"å¹³å‡å€¤ãŒ10ã€æ¨™æº–åå·®ãŒ2ã®ã¨ãã€ãƒ‡ãƒ¼ã‚¿ã®æ•£ã‚‰ã°ã‚Šã‚’è¡¨ã™æŒ‡æ¨™ã¯ã©ã‚Œã§ã™ã‹ã€‚","options":["å¹³å‡å€¤","æ¨™æº–åå·®","ä¸­å¤®å€¤","æœ€é »å€¤"],"correct":2,"explanation":"æ¨™æº–åå·®ã¯ãƒ‡ãƒ¼ã‚¿ã®æ•£ã‚‰ã°ã‚Šã‚’è¡¨ã™æŒ‡æ¨™ã§ã™ã€‚"},{"id":2,"question":"ä¸‹ã®æ•£å¸ƒå›³ã«ã¤ã„ã¦ã€ç›¸é–¢ã‚’åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚","options":["å¼·ã„æ­£ã®ç›¸é–¢","å¼·ã„è² ã®ç›¸é–¢","ç›¸é–¢ãªã—","ä¸æ˜"],"correct":1,"explanation":"å³ä¸ŠãŒã‚Šãªã®ã§æ­£ã®ç›¸é–¢ã§ã™ã€‚","chartType":"scatter","chartData":[{"x":1,"y":2.1},{"x":2,"y":4.0},{"x":3,"y":5.9}],"chartLabels":{"x":"å¤‰æ•°X","y":"å¤‰æ•°Y"}}]

âš ï¸ æ–‡å­—åˆ—å†…ã®ãƒ«ãƒ¼ãƒ«:
- æ”¹è¡Œã¯ä½¿ã‚ãªã„ â†’ ã‚¹ãƒšãƒ¼ã‚¹ã§ä»£ç”¨
- ã‚¿ãƒ–ã¯ä½¿ã‚ãªã„ â†’ ã‚¹ãƒšãƒ¼ã‚¹ã§ä»£ç”¨
- å¼•ç”¨ç¬¦ã¯ \" ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
- ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã¯ \\\\ ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—

âš ï¸ JSONæ§‹é€ :
- å¿…ãšé…åˆ— [...] ã§å›²ã‚€
- æœ€å¾Œã®è¦ç´ ã®å¾Œã«ã‚«ãƒ³ãƒã‚’ä»˜ã‘ãªã„
- ã‚°ãƒ©ãƒ•ä½¿ç”¨ç‡60-70%

ã€é‡è¦ã€‘
- ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯å¿…ãšå°æ–‡å­—ã§è¨˜è¿°ã—ã¦ãã ã•ã„
- chartDataã¨barDataã‚’åŒæ™‚ã«å«ã‚ãªã„ã§ãã ã•ã„
- ã‚°ãƒ©ãƒ•ãªã—ã®å•é¡Œã§ã¯ã€chartTypeç­‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚ãªã„ã§ãã ã•ã„
- ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã¯ chartType: "histogram" ã‚’ä½¿ç”¨ï¼ˆ"bar"ã¨æ··åŒã—ãªã„ï¼‰
- ç®±ã²ã’å›³ã¯ chartType: "boxplot" ã‚’ä½¿ç”¨ã—ã€boxPlotData ã‚’å¿…ãšå«ã‚ã‚‹
- barData ã¯ "bar" ã¨ "histogram" ã§å…±ç”¨
- boxPlotData ã¯ "boxplot" å°‚ç”¨ã§ã€{"min": æ•°å€¤, "q1": æ•°å€¤, "median": æ•°å€¤, "q3": æ•°å€¤, "max": æ•°å€¤} ã®å½¢å¼

ã€é¸æŠè‚¢ä½œæˆã®æ³¨æ„ç‚¹ - æœ€é‡è¦ã€‘
âš ï¸ ç¢ºç‡ãƒ»åˆ†æ•°ã®é¸æŠè‚¢ã§ã¯ã€å¿…ãšæ—¢ç´„åˆ†æ•°ï¼ˆç´„åˆ†æ¸ˆã¿ï¼‰ã«ã—ã¦ãã ã•ã„

ğŸš¨ çµ¶å¯¾ã«é¿ã‘ã‚‹ã¹ãé‡è¤‡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š
- ã€Œ1/4ã€ã¨ã€Œ13/52ã€ã¯åŒã˜å€¤ â†’ ã€Œ1/4ã€ã®ã¿ä½¿ç”¨
- ã€Œ1/2ã€ã¨ã€Œ2/4ã€ã€Œ3/6ã€ã€Œ50/100ã€ã¯åŒã˜å€¤ â†’ ã€Œ1/2ã€ã®ã¿ä½¿ç”¨
- ã€Œ1/3ã€ã¨ã€Œ2/6ã€ã€Œ3/9ã€ã¯åŒã˜å€¤ â†’ ã€Œ1/3ã€ã®ã¿ä½¿ç”¨
- ã€Œ4/25ã€ã¨ã€Œ16/100ã€ã¯åŒã˜å€¤ â†’ ã€Œ4/25ã€ã®ã¿ä½¿ç”¨
- ã€Œ5/14ã€ã¨ã€Œ10/28ã€ã¯åŒã˜å€¤ â†’ ã€Œ5/14ã€ã®ã¿ä½¿ç”¨
- ã€Œ1/25ã€ã¨ã€Œ4/100ã€ã¯åŒã˜å€¤ â†’ ã€Œ1/25ã€ã®ã¿ä½¿ç”¨

âœ… é¸æŠè‚¢ä½œæˆã®æ‰‹é †ï¼š
1. ã¾ãšæ­£è§£ã®åˆ†æ•°ã‚’æ—¢ç´„åˆ†æ•°ã«ã™ã‚‹
2. èª¤ç­”ã®åˆ†æ•°ã‚‚æ—¢ç´„åˆ†æ•°ã«ã™ã‚‹
3. ã™ã¹ã¦ã®é¸æŠè‚¢ã‚’å°æ•°ã«å¤‰æ›ã—ã¦é‡è¤‡ãŒãªã„ã‹ç¢ºèªã™ã‚‹
4. é‡è¤‡ãŒã‚ã‚Œã°åˆ¥ã®å€¤ã«å¤‰æ›´ã™ã‚‹

âŒ çµ¶å¯¾NGï¼š
- åŒã˜å€¤ã‚’ç•°ãªã‚‹å½¢ã§è¡¨ç¾ï¼ˆä¾‹ï¼š1/2ã¨2/4ï¼‰
- ç´„åˆ†å‰ã®åˆ†æ•°ã¨ç´„åˆ†å¾Œã®åˆ†æ•°ã®æ··åœ¨ï¼ˆä¾‹ï¼š4/25ã¨16/100ï¼‰

ã™ã¹ã¦ã®é¸æŠè‚¢ã¯æ˜ç¢ºã«ç•°ãªã‚‹å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

ã€ğŸš¨ ã‚°ãƒ©ãƒ•å‚ç…§ã®å³æ ¼ãƒ«ãƒ¼ãƒ« - æœ€å„ªå…ˆäº‹é … ğŸš¨ã€‘
âš ï¸ ã“ã®ãƒ«ãƒ¼ãƒ«ã¯çµ¶å¯¾ã«å®ˆã£ã¦ãã ã•ã„ã€‚é•åã¯é‡å¤§ãªã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

1ï¸âƒ£ ã‚°ãƒ©ãƒ•å‚ç…§è¡¨ç¾ã‚’ä½¿ã£ãŸå ´åˆã¯**å¿…ãš**ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹
   ç¦æ­¢è¡¨ç¾ï¼ˆã“ã‚Œã‚‰ã‚’ä½¿ã†å ´åˆã¯å¿…ãšchartTypeã€chartData/barDataã€chartLabelsã‚’å«ã‚ã‚‹ï¼‰:
   - ã€Œä¸‹ã®ã‚°ãƒ©ãƒ•ã€ã€Œæ¬¡ã®ã‚°ãƒ©ãƒ•ã€ã€Œä»¥ä¸‹ã®ã‚°ãƒ©ãƒ•ã€
   - ã€Œä¸‹ã®å›³ã€ã€Œæ¬¡ã®å›³ã€ã€Œä»¥ä¸‹ã®å›³ã€
   - ã€Œä¸‹ã®æ•£å¸ƒå›³ã€ã€Œæ¬¡ã®æ•£å¸ƒå›³ã€
   - ã€Œä¸‹ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã€ã€Œæ¬¡ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã€
   - ã€Œä¸‹ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã€ã€Œæ¬¡ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã€
   - ã€Œä¸‹ã®æ£’ã‚°ãƒ©ãƒ•ã€ã€Œæ¬¡ã®æ£’ã‚°ãƒ©ãƒ•ã€

2ï¸âƒ£ ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãŒãªã„å•é¡Œã§ã¯ã€ä¸Šè¨˜ã®è¡¨ç¾ã‚’**çµ¶å¯¾ã«ä½¿ã‚ãªã„**
   âœ… æ­£ã—ã„è¡¨ç¾: ã€Œç›¸é–¢ä¿‚æ•°ãŒ0.9ã®ã¨ã...ã€ã€Œåº¦æ•°ãŒæœ€ã‚‚å¤šã„éšç´šã‚’é¸ã³ãªã•ã„ã€
   âŒ é–“é•ã„: ã€Œæ¬¡ã®ã‚°ãƒ©ãƒ•ã§ç›¸é–¢ä¿‚æ•°ãŒ...ã€ï¼ˆã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰

3ï¸âƒ£ å•é¡Œæ–‡ä½œæˆæ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
   - å•é¡Œæ–‡ã«ã€Œä¸‹ã®ã€ã€Œæ¬¡ã®ã€ãŒå«ã¾ã‚Œã‚‹ â†’ chartTypeã‚’ç¢ºèª
   - chartTypeãŒã‚ã‚‹ â†’ å•é¡Œæ–‡ã«ã€Œä¸‹ã®â—‹â—‹ã€ã‚’å«ã‚ã‚‹
   - chartTypeãŒãªã„ â†’ å•é¡Œæ–‡ã«ã€Œä¸‹ã®â—‹â—‹ã€ã‚’å«ã‚ãªã„

4ï¸âƒ£ æ•´åˆæ€§ã®ä¾‹
   âœ… æ­£ã—ã„ä¾‹:
   {
     "question": "ä¸‹ã®æ•£å¸ƒå›³ã«ã¤ã„ã¦ã€ç›¸é–¢ä¿‚æ•°ã®å€¤ã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ã€‚",
     "chartType": "scatter",
     "chartData": [...]
   }
   
   âŒ é–“é•ã„ã®ä¾‹:
   {
     "question": "æ¬¡ã®ã‚°ãƒ©ãƒ•ã§ã€ç›¸é–¢ä¿‚æ•°ã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ã€‚",
     // chartTypeãŒãªã„ï¼ã“ã‚Œã¯çµ¶å¯¾ã«NGï¼
   }

âš ï¸ ã“ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã¯å•é¡Œç”Ÿæˆã®æœ€å„ªå…ˆäº‹é …ã§ã™ã€‚å¿…ãšå®ˆã£ã¦ãã ã•ã„ã€‚`;
  } else {
    const topics = request.grade === '4ç´š' ? grade4Topics : grade3Topics;
    prompt = `ã‚ãªãŸã¯çµ±è¨ˆæ¤œå®šã®å•é¡Œä½œæˆã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã§æ¨¡æ“¬è©¦é¨“å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€æ¡ä»¶ã€‘
- ç´š: ${request.grade}
- è©¦é¨“å½¢å¼: æ¨¡æ“¬è©¦é¨“ï¼ˆå…¨ç¯„å›²ã‹ã‚‰å‡ºé¡Œï¼‰
- å•é¡Œæ•°: ${request.count}å•

${topics}

ã€è¦ä»¶ã€‘
1. å„å•é¡Œã¯4æŠå½¢å¼
2. æ­£è§£ã¯1ã€œ4ã®æ•°å­—ã§æŒ‡å®š
3. è©³ã—ã„è§£èª¬ã‚’å«ã‚ã‚‹
4. ${request.grade}ã®é›£æ˜“åº¦ã«é©ã—ãŸå•é¡Œ
5. å®Ÿéš›ã®çµ±è¨ˆæ¤œå®šã®å‡ºé¡Œå½¢å¼ã«è¿‘ã„å•é¡Œ
6. å…¨ç¯„å›²ã‹ã‚‰ãƒãƒ©ãƒ³ã‚¹ã‚ˆãå‡ºé¡Œï¼ˆç‰¹å®šã®åˆ†é‡ã«åã‚‰ãªã„ï¼‰
7. éå»å•ã®å‡ºé¡Œå‚¾å‘ã‚’è€ƒæ…®ã—ãŸå•é¡Œ

ã€${request.grade}ã®ç‰¹å¾´ã€‘
${request.grade === '4ç´š' 
  ? '- ã‚°ãƒ©ãƒ•èª­è§£å•é¡Œã‚’15-20%ç¨‹åº¦å«ã‚ã‚‹ï¼ˆãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã€æ•£å¸ƒå›³ãªã©ï¼‰\n- åº¦æ•°åˆ†å¸ƒè¡¨ã®å•é¡Œã‚’15-20%ç¨‹åº¦å«ã‚ã‚‹\n- ç¢ºç‡ã®åŸºæœ¬å•é¡Œã‚’10%ç¨‹åº¦å«ã‚ã‚‹\n- å…·ä½“çš„ãªæ•°å€¤ã‚’ä½¿ã£ãŸè¨ˆç®—å•é¡Œã‚’å¤šã‚ã«'
  : '- æ¨æ¸¬çµ±è¨ˆã®å•é¡Œã‚’25-30%ç¨‹åº¦å«ã‚ã‚‹\n- ç›¸é–¢ãƒ»å›å¸°åˆ†æã‚’15-20%ç¨‹åº¦å«ã‚ã‚‹ï¼ˆæ•£å¸ƒå›³ã‚’å«ã‚€ï¼‰\n- ä»®èª¬æ¤œå®šã®å•é¡Œã‚’20-25%ç¨‹åº¦å«ã‚ã‚‹\n- æ¦‚å¿µç†è§£ã‚’å•ã†å•é¡Œã¨è¨ˆç®—å•é¡Œã‚’ãƒãƒ©ãƒ³ã‚¹ã‚ˆã'
}

ã€å‡ºåŠ›å½¢å¼ã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆJSONã®ã¿ã‚’å‡ºåŠ›ã—ã€ä»–ã®æ–‡ç« ã¯å«ã‚ãªã„ã§ãã ã•ã„ï¼‰ï¼š

åŸºæœ¬å½¢å¼ï¼ˆã‚°ãƒ©ãƒ•ãªã—ï¼‰:
[
  {
    "id": 1,
    "question": "å•é¡Œæ–‡",
    "options": ["é¸æŠè‚¢1", "é¸æŠè‚¢2", "é¸æŠè‚¢3", "é¸æŠè‚¢4"],
    "correct": 2,
    "explanation": "è©³ã—ã„è§£èª¬"
  }
]


ã€é‡è¦ã€‘
- ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯å¿…ãšå°æ–‡å­—ã§è¨˜è¿°ã—ã¦ãã ã•ã„
- chartDataã¨barDataã‚’åŒæ™‚ã«å«ã‚ãªã„ã§ãã ã•ã„
- ã‚°ãƒ©ãƒ•ãªã—ã®å•é¡Œã§ã¯ã€chartTypeç­‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚ãªã„ã§ãã ã•ã„
- ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã¯ chartType: "histogram" ã‚’ä½¿ç”¨ï¼ˆ"bar"ã¨æ··åŒã—ãªã„ï¼‰
- ç®±ã²ã’å›³ã¯ chartType: "boxplot" ã‚’ä½¿ç”¨ã—ã€boxPlotData ã‚’å¿…ãšå«ã‚ã‚‹
- barData ã¯ "bar" ã¨ "histogram" ã§å…±ç”¨
- boxPlotData ã¯ "boxplot" å°‚ç”¨ã§ã€{"min": æ•°å€¤, "q1": æ•°å€¤, "median": æ•°å€¤, "q3": æ•°å€¤, "max": æ•°å€¤} ã®å½¢å¼

ã€é¸æŠè‚¢ä½œæˆã®æ³¨æ„ç‚¹ - æœ€é‡è¦ã€‘
âš ï¸ ç¢ºç‡ãƒ»åˆ†æ•°ã®é¸æŠè‚¢ã§ã¯ã€å¿…ãšæ—¢ç´„åˆ†æ•°ï¼ˆç´„åˆ†æ¸ˆã¿ï¼‰ã«ã—ã¦ãã ã•ã„

ğŸš¨ çµ¶å¯¾ã«é¿ã‘ã‚‹ã¹ãé‡è¤‡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š
- ã€Œ1/4ã€ã¨ã€Œ13/52ã€ã¯åŒã˜å€¤ â†’ ã€Œ1/4ã€ã®ã¿ä½¿ç”¨
- ã€Œ1/2ã€ã¨ã€Œ2/4ã€ã€Œ3/6ã€ã€Œ50/100ã€ã¯åŒã˜å€¤ â†’ ã€Œ1/2ã€ã®ã¿ä½¿ç”¨
- ã€Œ1/3ã€ã¨ã€Œ2/6ã€ã€Œ3/9ã€ã¯åŒã˜å€¤ â†’ ã€Œ1/3ã€ã®ã¿ä½¿ç”¨
- ã€Œ4/25ã€ã¨ã€Œ16/100ã€ã¯åŒã˜å€¤ â†’ ã€Œ4/25ã€ã®ã¿ä½¿ç”¨
- ã€Œ5/14ã€ã¨ã€Œ10/28ã€ã¯åŒã˜å€¤ â†’ ã€Œ5/14ã€ã®ã¿ä½¿ç”¨
- ã€Œ1/25ã€ã¨ã€Œ4/100ã€ã¯åŒã˜å€¤ â†’ ã€Œ1/25ã€ã®ã¿ä½¿ç”¨

âœ… é¸æŠè‚¢ä½œæˆã®æ‰‹é †ï¼š
1. ã¾ãšæ­£è§£ã®åˆ†æ•°ã‚’æ—¢ç´„åˆ†æ•°ã«ã™ã‚‹
2. èª¤ç­”ã®åˆ†æ•°ã‚‚æ—¢ç´„åˆ†æ•°ã«ã™ã‚‹
3. ã™ã¹ã¦ã®é¸æŠè‚¢ã‚’å°æ•°ã«å¤‰æ›ã—ã¦é‡è¤‡ãŒãªã„ã‹ç¢ºèªã™ã‚‹
4. é‡è¤‡ãŒã‚ã‚Œã°åˆ¥ã®å€¤ã«å¤‰æ›´ã™ã‚‹

âŒ çµ¶å¯¾NGï¼š
- åŒã˜å€¤ã‚’ç•°ãªã‚‹å½¢ã§è¡¨ç¾ï¼ˆä¾‹ï¼š1/2ã¨2/4ï¼‰
- ç´„åˆ†å‰ã®åˆ†æ•°ã¨ç´„åˆ†å¾Œã®åˆ†æ•°ã®æ··åœ¨ï¼ˆä¾‹ï¼š4/25ã¨16/100ï¼‰

ã™ã¹ã¦ã®é¸æŠè‚¢ã¯æ˜ç¢ºã«ç•°ãªã‚‹å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

ã€ğŸš¨ ã‚°ãƒ©ãƒ•å‚ç…§ã®å³æ ¼ãƒ«ãƒ¼ãƒ« - æœ€å„ªå…ˆäº‹é … ğŸš¨ã€‘
âš ï¸ ã“ã®ãƒ«ãƒ¼ãƒ«ã¯çµ¶å¯¾ã«å®ˆã£ã¦ãã ã•ã„ã€‚é•åã¯é‡å¤§ãªã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

1ï¸âƒ£ ã‚°ãƒ©ãƒ•å‚ç…§è¡¨ç¾ã‚’ä½¿ã£ãŸå ´åˆã¯**å¿…ãš**ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹
   ç¦æ­¢è¡¨ç¾ï¼ˆã“ã‚Œã‚‰ã‚’ä½¿ã†å ´åˆã¯å¿…ãšchartTypeã€chartData/barDataã€chartLabelsã‚’å«ã‚ã‚‹ï¼‰:
   - ã€Œä¸‹ã®ã‚°ãƒ©ãƒ•ã€ã€Œæ¬¡ã®ã‚°ãƒ©ãƒ•ã€ã€Œä»¥ä¸‹ã®ã‚°ãƒ©ãƒ•ã€
   - ã€Œä¸‹ã®å›³ã€ã€Œæ¬¡ã®å›³ã€ã€Œä»¥ä¸‹ã®å›³ã€
   - ã€Œä¸‹ã®æ•£å¸ƒå›³ã€ã€Œæ¬¡ã®æ•£å¸ƒå›³ã€
   - ã€Œä¸‹ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã€ã€Œæ¬¡ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã€
   - ã€Œä¸‹ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã€ã€Œæ¬¡ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã€
   - ã€Œä¸‹ã®æ£’ã‚°ãƒ©ãƒ•ã€ã€Œæ¬¡ã®æ£’ã‚°ãƒ©ãƒ•ã€

2ï¸âƒ£ ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãŒãªã„å•é¡Œã§ã¯ã€ä¸Šè¨˜ã®è¡¨ç¾ã‚’**çµ¶å¯¾ã«ä½¿ã‚ãªã„**
   âœ… æ­£ã—ã„è¡¨ç¾: ã€Œç›¸é–¢ä¿‚æ•°ãŒ0.9ã®ã¨ã...ã€ã€Œåº¦æ•°ãŒæœ€ã‚‚å¤šã„éšç´šã‚’é¸ã³ãªã•ã„ã€
   âŒ é–“é•ã„: ã€Œæ¬¡ã®ã‚°ãƒ©ãƒ•ã§ç›¸é–¢ä¿‚æ•°ãŒ...ã€ï¼ˆã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰

3ï¸âƒ£ å•é¡Œæ–‡ä½œæˆæ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
   - å•é¡Œæ–‡ã«ã€Œä¸‹ã®ã€ã€Œæ¬¡ã®ã€ãŒå«ã¾ã‚Œã‚‹ â†’ chartTypeã‚’ç¢ºèª
   - chartTypeãŒã‚ã‚‹ â†’ å•é¡Œæ–‡ã«ã€Œä¸‹ã®â—‹â—‹ã€ã‚’å«ã‚ã‚‹
   - chartTypeãŒãªã„ â†’ å•é¡Œæ–‡ã«ã€Œä¸‹ã®â—‹â—‹ã€ã‚’å«ã‚ãªã„

4ï¸âƒ£ æ•´åˆæ€§ã®ä¾‹
   âœ… æ­£ã—ã„ä¾‹:
   {
     "question": "ä¸‹ã®æ•£å¸ƒå›³ã«ã¤ã„ã¦ã€ç›¸é–¢ä¿‚æ•°ã®å€¤ã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ã€‚",
     "chartType": "scatter",
     "chartData": [...]
   }
   
   âŒ é–“é•ã„ã®ä¾‹:
   {
     "question": "æ¬¡ã®ã‚°ãƒ©ãƒ•ã§ã€ç›¸é–¢ä¿‚æ•°ã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ã€‚",
     // chartTypeãŒãªã„ï¼ã“ã‚Œã¯çµ¶å¯¾ã«NGï¼
   }

âš ï¸ ã“ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã¯å•é¡Œç”Ÿæˆã®æœ€å„ªå…ˆäº‹é …ã§ã™ã€‚å¿…ãšå®ˆã£ã¦ãã ã•ã„ã€‚`;
  }

  try {
    validateRequest(request);

    const generateWithRetry = async (): Promise<GeneratedQuestion[]> => {
      try {
        const result = await withTimeout(
          model.generateContent(prompt),
          API_TIMEOUT
        );

        const response = result.response;
        
        if (!response) {
          throw new APIError('APIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã§ã™ã€‚');
        }

        let text: string;
        try {
          text = response.text();
        } catch (textError) {
          console.error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', textError);
          throw new APIError('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
        }

        if (!text || text.trim().length === 0) {
          throw new APIError('APIã‹ã‚‰ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚');
        }

        // JSON modeä½¿ç”¨æ™‚ã¯ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯æ—¢ã«æœ‰åŠ¹ãªJSONã®ã¯ãš
        let parsedData: any;
        
        try {
          // ç›´æ¥ãƒ‘ãƒ¼ã‚¹ï¼ˆJSON modeãªã®ã§æ•´å½¢æ¸ˆã¿ï¼‰
          parsedData = JSON.parse(text);
          console.log('âœ… JSON modeã«ã‚ˆã‚‹ç›´æ¥ãƒ‘ãƒ¼ã‚¹æˆåŠŸ');
          
        } catch (parseError) {
          console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
          console.error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæœ€åˆã®1000æ–‡å­—ï¼‰:', text.substring(0, 1000));
          
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é…åˆ—ã‚’æŠ½å‡ºã—ã¦å†è©¦è¡Œ
          try {
            const jsonMatch = text.match(/\[[\s\S]*\]/);
            if (!jsonMatch) {
              throw new Error('JSONé…åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            parsedData = JSON.parse(jsonMatch[0]);
            console.log('âœ… é…åˆ—æŠ½å‡ºå¾Œã®ãƒ‘ãƒ¼ã‚¹æˆåŠŸ');
            
          } catch (secondError) {
            console.error('é…åˆ—æŠ½å‡ºå¾Œã‚‚ãƒ‘ãƒ¼ã‚¹å¤±æ•—:', secondError);
            throw new ValidationError(
              'JSONãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
            );
          }
        }

        if (!Array.isArray(parsedData)) {
          throw new ValidationError('AIã®å¿œç­”ãŒé…åˆ—å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
        }

        if (parsedData.length === 0) {
          throw new ValidationError('AIãŒå•é¡Œã‚’ç”Ÿæˆã—ã¾ã›ã‚“ã§ã—ãŸã€‚');
        }

        if (parsedData.length !== request.count) {
          console.warn(
            `è¦æ±‚ã•ã‚ŒãŸå•é¡Œæ•°ï¼ˆ${request.count}ï¼‰ã¨ç”Ÿæˆã•ã‚ŒãŸå•é¡Œæ•°ï¼ˆ${parsedData.length}ï¼‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚`
          );
        }

        const validatedQuestions: GeneratedQuestion[] = [];
        for (let i = 0; i < parsedData.length; i++) {
          try {
            const validated = validateQuestion(parsedData[i], i);
            
            validated.question = sanitizeText(validated.question);
            validated.options = validated.options.map(opt => sanitizeText(opt));
            validated.explanation = sanitizeText(validated.explanation);
            
            ensureGraphData(validated);
            
            validatedQuestions.push(validated);
          } catch (validationError) {
            console.error(`å•é¡Œ${i + 1}ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:`, validationError);
            throw validationError;
          }
        }

        if (validatedQuestions.length < Math.min(3, request.count)) {
          throw new ValidationError(
            `æœ‰åŠ¹ãªå•é¡ŒãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆ${validatedQuestions.length}/${request.count}ï¼‰ã€‚`
          );
        }

        return validatedQuestions.slice(0, request.count);

      } catch (error) {
        if (error instanceof ValidationError || error instanceof TimeoutError || error instanceof RateLimitError) {
          throw error;
        }

        if (error instanceof Error) {
          const errorMessage = error.message.toLowerCase();
          
          if (errorMessage.includes('429') || errorMessage.includes('rate limit') || errorMessage.includes('too many requests')) {
            const retryAfter = 60000;
            throw new RateLimitError(
              'APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚1åˆ†å¾Œã«è‡ªå‹•çš„ã«ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ã€‚', 
              retryAfter
            );
          }
          
          if (errorMessage.includes('quota exceeded') || errorMessage.includes('quota')) {
            throw new RateLimitError(
              'APIä½¿ç”¨é‡ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚',
              300000
            );
          }
          
          if (errorMessage.includes('api key') || errorMessage.includes('unauthorized')) {
            throw new APIError('APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 401);
          }
          
          if (errorMessage.includes('network') || errorMessage.includes('fetch')) {
            throw new APIError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
        }

        throw new APIError(
          `å•é¡Œç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`
        );
      }
    };

    return await retryWithBackoff(generateWithRetry);

  } catch (error) {
    console.error('å•é¡Œç”Ÿæˆã®æœ€çµ‚ã‚¨ãƒ©ãƒ¼:', error);

    if (error instanceof ValidationError) {
      throw error;
    }
    if (error instanceof RateLimitError) {
      const waitMinutes = Math.ceil(error.retryAfter / 60000);
      throw new Error(
        `APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚${waitMinutes}åˆ†ã»ã©å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚`
      );
    }
    if (error instanceof TimeoutError) {
      throw new Error(
        'å•é¡Œã®ç”Ÿæˆã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™ã€‚å•é¡Œæ•°ã‚’æ¸›ã‚‰ã™ã‹ã€ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚'
      );
    }
    if (error instanceof APIError) {
      throw new Error(error.message);
    }

    throw new Error(
      'å•é¡Œã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ã„ãŸã ãã‹ã€å•é¡Œæ•°ã‚’æ¸›ã‚‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚'
    );
  }
}

